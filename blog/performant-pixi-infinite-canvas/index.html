<!DOCTYPE html><html  lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style id="nuxt-ui-colors">@layer theme {
  :root, :host {
  --ui-color-primary-50: var(--color-blue-50, oklch(97% 0.014 254.604));
  --ui-color-primary-100: var(--color-blue-100, oklch(93.2% 0.032 255.585));
  --ui-color-primary-200: var(--color-blue-200, oklch(88.2% 0.059 254.128));
  --ui-color-primary-300: var(--color-blue-300, oklch(80.9% 0.105 251.813));
  --ui-color-primary-400: var(--color-blue-400, oklch(70.7% 0.165 254.624));
  --ui-color-primary-500: var(--color-blue-500, oklch(62.3% 0.214 259.815));
  --ui-color-primary-600: var(--color-blue-600, oklch(54.6% 0.245 262.881));
  --ui-color-primary-700: var(--color-blue-700, oklch(48.8% 0.243 264.376));
  --ui-color-primary-800: var(--color-blue-800, oklch(42.4% 0.199 265.638));
  --ui-color-primary-900: var(--color-blue-900, oklch(37.9% 0.146 265.522));
  --ui-color-primary-950: var(--color-blue-950, oklch(28.2% 0.091 267.935));
  --ui-color-secondary-50: var(--color-blue-50, oklch(97% 0.014 254.604));
  --ui-color-secondary-100: var(--color-blue-100, oklch(93.2% 0.032 255.585));
  --ui-color-secondary-200: var(--color-blue-200, oklch(88.2% 0.059 254.128));
  --ui-color-secondary-300: var(--color-blue-300, oklch(80.9% 0.105 251.813));
  --ui-color-secondary-400: var(--color-blue-400, oklch(70.7% 0.165 254.624));
  --ui-color-secondary-500: var(--color-blue-500, oklch(62.3% 0.214 259.815));
  --ui-color-secondary-600: var(--color-blue-600, oklch(54.6% 0.245 262.881));
  --ui-color-secondary-700: var(--color-blue-700, oklch(48.8% 0.243 264.376));
  --ui-color-secondary-800: var(--color-blue-800, oklch(42.4% 0.199 265.638));
  --ui-color-secondary-900: var(--color-blue-900, oklch(37.9% 0.146 265.522));
  --ui-color-secondary-950: var(--color-blue-950, oklch(28.2% 0.091 267.935));
  --ui-color-success-50: var(--color-green-50, oklch(98.2% 0.018 155.826));
  --ui-color-success-100: var(--color-green-100, oklch(96.2% 0.044 156.743));
  --ui-color-success-200: var(--color-green-200, oklch(92.5% 0.084 155.995));
  --ui-color-success-300: var(--color-green-300, oklch(87.1% 0.15 154.449));
  --ui-color-success-400: var(--color-green-400, oklch(79.2% 0.209 151.711));
  --ui-color-success-500: var(--color-green-500, oklch(72.3% 0.219 149.579));
  --ui-color-success-600: var(--color-green-600, oklch(62.7% 0.194 149.214));
  --ui-color-success-700: var(--color-green-700, oklch(52.7% 0.154 150.069));
  --ui-color-success-800: var(--color-green-800, oklch(44.8% 0.119 151.328));
  --ui-color-success-900: var(--color-green-900, oklch(39.3% 0.095 152.535));
  --ui-color-success-950: var(--color-green-950, oklch(26.6% 0.065 152.934));
  --ui-color-info-50: var(--color-blue-50, oklch(97% 0.014 254.604));
  --ui-color-info-100: var(--color-blue-100, oklch(93.2% 0.032 255.585));
  --ui-color-info-200: var(--color-blue-200, oklch(88.2% 0.059 254.128));
  --ui-color-info-300: var(--color-blue-300, oklch(80.9% 0.105 251.813));
  --ui-color-info-400: var(--color-blue-400, oklch(70.7% 0.165 254.624));
  --ui-color-info-500: var(--color-blue-500, oklch(62.3% 0.214 259.815));
  --ui-color-info-600: var(--color-blue-600, oklch(54.6% 0.245 262.881));
  --ui-color-info-700: var(--color-blue-700, oklch(48.8% 0.243 264.376));
  --ui-color-info-800: var(--color-blue-800, oklch(42.4% 0.199 265.638));
  --ui-color-info-900: var(--color-blue-900, oklch(37.9% 0.146 265.522));
  --ui-color-info-950: var(--color-blue-950, oklch(28.2% 0.091 267.935));
  --ui-color-warning-50: var(--color-yellow-50, oklch(98.7% 0.026 102.212));
  --ui-color-warning-100: var(--color-yellow-100, oklch(97.3% 0.071 103.193));
  --ui-color-warning-200: var(--color-yellow-200, oklch(94.5% 0.129 101.54));
  --ui-color-warning-300: var(--color-yellow-300, oklch(90.5% 0.182 98.111));
  --ui-color-warning-400: var(--color-yellow-400, oklch(85.2% 0.199 91.936));
  --ui-color-warning-500: var(--color-yellow-500, oklch(79.5% 0.184 86.047));
  --ui-color-warning-600: var(--color-yellow-600, oklch(68.1% 0.162 75.834));
  --ui-color-warning-700: var(--color-yellow-700, oklch(55.4% 0.135 66.442));
  --ui-color-warning-800: var(--color-yellow-800, oklch(47.6% 0.114 61.907));
  --ui-color-warning-900: var(--color-yellow-900, oklch(42.1% 0.095 57.708));
  --ui-color-warning-950: var(--color-yellow-950, oklch(28.6% 0.066 53.813));
  --ui-color-error-50: var(--color-red-50, oklch(97.1% 0.013 17.38));
  --ui-color-error-100: var(--color-red-100, oklch(93.6% 0.032 17.717));
  --ui-color-error-200: var(--color-red-200, oklch(88.5% 0.062 18.334));
  --ui-color-error-300: var(--color-red-300, oklch(80.8% 0.114 19.571));
  --ui-color-error-400: var(--color-red-400, oklch(70.4% 0.191 22.216));
  --ui-color-error-500: var(--color-red-500, oklch(63.7% 0.237 25.331));
  --ui-color-error-600: var(--color-red-600, oklch(57.7% 0.245 27.325));
  --ui-color-error-700: var(--color-red-700, oklch(50.5% 0.213 27.518));
  --ui-color-error-800: var(--color-red-800, oklch(44.4% 0.177 26.899));
  --ui-color-error-900: var(--color-red-900, oklch(39.6% 0.141 25.723));
  --ui-color-error-950: var(--color-red-950, oklch(25.8% 0.092 26.042));
  --ui-color-neutral-50: var(--color-old-neutral-50, oklch(98.5% 0 0));
  --ui-color-neutral-100: var(--color-old-neutral-100, oklch(97% 0 0));
  --ui-color-neutral-200: var(--color-old-neutral-200, oklch(92.2% 0 0));
  --ui-color-neutral-300: var(--color-old-neutral-300, oklch(87% 0 0));
  --ui-color-neutral-400: var(--color-old-neutral-400, oklch(70.8% 0 0));
  --ui-color-neutral-500: var(--color-old-neutral-500, oklch(55.6% 0 0));
  --ui-color-neutral-600: var(--color-old-neutral-600, oklch(43.9% 0 0));
  --ui-color-neutral-700: var(--color-old-neutral-700, oklch(37.1% 0 0));
  --ui-color-neutral-800: var(--color-old-neutral-800, oklch(26.9% 0 0));
  --ui-color-neutral-900: var(--color-old-neutral-900, oklch(20.5% 0 0));
  --ui-color-neutral-950: var(--color-old-neutral-950, oklch(14.5% 0 0));
  }
  :root, :host, .light {
  --ui-primary: var(--ui-color-primary-500);
  --ui-secondary: var(--ui-color-secondary-500);
  --ui-success: var(--ui-color-success-500);
  --ui-info: var(--ui-color-info-500);
  --ui-warning: var(--ui-color-warning-500);
  --ui-error: var(--ui-color-error-500);
  }
  .dark {
  --ui-primary: var(--ui-color-primary-400);
  --ui-secondary: var(--ui-color-secondary-400);
  --ui-success: var(--ui-color-success-400);
  --ui-info: var(--ui-color-info-400);
  --ui-warning: var(--ui-color-warning-400);
  --ui-error: var(--ui-color-error-400);
  }
}</style><title>Handling Thousands Cards on an Infinite Canvas - Nuxt Portfolio Template</title><style>::view-transition-new(root),::view-transition-old(root){animation:none;mix-blend-mode:normal}::view-transition-new(root){z-index:9999}::view-transition-old(root){z-index:1}</style><style>.shiki span.line{display:block}.shiki span.line.highlight{background-color:var(--ui-bg-accented);margin:0 -16px;padding:0 16px}@supports (color:color-mix(in lab,red,red)){.shiki span.line.highlight{background-color:color-mix(in oklab,var(--ui-bg-accented)50%,transparent)}}</style><link rel="stylesheet" href="/_nuxt/entry.67WeiFk1.css" crossorigin><style>@layer components {:where(.i-lucide\:chevron-down){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 9l6 6l6-6'/%3E%3C/svg%3E")}:where(.i-lucide\:chevron-left){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m15 18l-6-6l6-6'/%3E%3C/svg%3E")}:where(.i-lucide\:copy){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cg fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Crect width='14' height='14' x='8' y='8' rx='2' ry='2'/%3E%3Cpath d='M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2'/%3E%3C/g%3E%3C/svg%3E")}:where(.i-lucide\:file-text){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cg fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Cpath d='M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z'/%3E%3Cpath d='M14 2v5a1 1 0 0 0 1 1h5M10 9H8m8 4H8m8 4H8'/%3E%3C/g%3E%3C/svg%3E")}:where(.i-lucide\:hash){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 9h16M4 15h16M10 3L8 21m8-18l-2 18'/%3E%3C/svg%3E")}:where(.i-lucide\:home){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cg fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Cpath d='M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8'/%3E%3Cpath d='M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z'/%3E%3C/g%3E%3C/svg%3E")}:where(.i-lucide\:user){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cg fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Cpath d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/g%3E%3C/svg%3E")}:where(.i-simple-icons\:github){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='black' d='M12 .297c-6.63 0-12 5.373-12 12c0 5.303 3.438 9.8 8.205 11.385c.6.113.82-.258.82-.577c0-.285-.01-1.04-.015-2.04c-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729c1.205.084 1.838 1.236 1.838 1.236c1.07 1.835 2.809 1.305 3.495.998c.108-.776.417-1.305.76-1.605c-2.665-.3-5.466-1.332-5.466-5.93c0-1.31.465-2.38 1.235-3.22c-.135-.303-.54-1.523.105-3.176c0 0 1.005-.322 3.3 1.23c.96-.267 1.98-.399 3-.405c1.02.006 2.04.138 3 .405c2.28-1.552 3.285-1.23 3.285-1.23c.645 1.653.24 2.873.12 3.176c.765.84 1.23 1.91 1.23 3.22c0 4.61-2.805 5.625-5.475 5.92c.42.36.81 1.096.81 2.22c0 1.606-.015 2.896-.015 3.286c0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E")}:where(.i-simple-icons\:x){display:inline-block;width:1em;height:1em;background-color:currentColor;-webkit-mask-image:var(--svg);mask-image:var(--svg);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;--svg:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='black' d='M14.234 10.162L22.977 0h-2.072l-7.591 8.824L7.251 0H.258l9.168 13.343L.258 24H2.33l8.016-9.318L16.749 24h6.993zm-2.837 3.299l-.929-1.329L3.076 1.56h3.182l5.965 8.532l.929 1.329l7.754 11.09h-3.182z'/%3E%3C/svg%3E")}}</style><link rel="preload" as="fetch" crossorigin="anonymous" href="/blog/performant-pixi-infinite-canvas/_payload.json?a1c5c142-49ea-45d5-bcb0-40beb2dec1ff"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BKh8bA8C.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/f8WFH6ZX.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DlAUqK2U.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BNEb2FJO.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BfP8iEm1.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BByABMIl.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BLETcTSH.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B6mvD8mD.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/iik6CYzq.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DHpZJDKh.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Dl0H27ZO.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/D1EYmXzn.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/I1f-rAA7.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CrMEwqFH.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Cfx5tzKO.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B8Kq0Gyt.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BuQgGJ8M.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BEpLs99c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CeHB8HaZ.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/xLKIrGyl.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CgDP42Wn.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DmK0mkUJ.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/8uayEIYt.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DNlQ_JLd.js"><script type="module" src="/_nuxt/BKh8bA8C.js" crossorigin></script><meta property="og:image" content="https://alanscodelog.github.io/__og-image__/static/blog/performant-pixi-infinite-canvas/og.png"><meta property="og:image:type" content="image/png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://alanscodelog.github.io/__og-image__/static/blog/performant-pixi-infinite-canvas/og.png"><meta name="twitter:image:src" content="https://alanscodelog.github.io/__og-image__/static/blog/performant-pixi-infinite-canvas/og.png"><meta property="og:image:width" content="1200"><meta name="twitter:image:width" content="1200"><meta property="og:image:height" content="600"><meta name="twitter:image:height" content="600"><link rel="icon" href="/icon.png" type="image/png" sizes="300x300"><meta property="og:type" content="website"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><meta name="theme-color" content="white"><link rel="icon" href="/favicon.ico"><meta name="description" content="A deep dive into the engineering behind Pyramid's infinite canvas and how to handle high-density layouts without sacrificing responsiveness â€” it covers texture baking, custom culling, background idle generation, efficient text handling, text truncation, and the dynamic LOD states required for massive datasets."><meta property="og:description" content="A deep dive into the engineering behind Pyramid's infinite canvas and how to handle high-density layouts without sacrificing responsiveness â€” it covers texture baking, custom culling, background idle generation, efficient text handling, text truncation, and the dynamic LOD states required for massive datasets."><meta property="og:title" content="Handling Thousands Cards on an Infinite Canvas"><link rel="canonical" href="https://alanscodelog.github.io/blog/performant-pixi-infinite-canvas/"><meta property="og:url" content="https://alanscodelog.github.io/blog/performant-pixi-infinite-canvas/"><meta property="og:site_name" content="Alan's Code Log"><script>"use strict";(()=>{const t=window,e=document.documentElement,c=["dark","light"],n=getStorageValue("localStorage","nuxt-color-mode")||"system";let i=n==="system"?u():n;const r=e.getAttribute("data-color-mode-forced");r&&(i=r),l(i),t["__NUXT_COLOR_MODE__"]={preference:n,value:i,getColorScheme:u,addColorScheme:l,removeColorScheme:d};function l(o){const s=""+o+"",a="";e.classList?e.classList.add(s):e.className+=" "+s,a&&e.setAttribute("data-"+a,o)}function d(o){const s=""+o+"",a="";e.classList?e.classList.remove(s):e.className=e.className.replace(new RegExp(s,"g"),""),a&&e.removeAttribute("data-"+a)}function f(o){return t.matchMedia("(prefers-color-scheme"+o+")")}function u(){if(t.matchMedia&&f("").media!=="not all"){for(const o of c)if(f(":"+o).matches)return o}return"light"}})();function getStorageValue(t,e){switch(t){case"localStorage":return window.localStorage.getItem(e);case"sessionStorage":return window.sessionStorage.getItem(e);case"cookie":return getCookie(e);default:return null}}function getCookie(t){const c=("; "+window.document.cookie).split("; "+t+"=");if(c.length===2)return c.pop()?.split(";").shift()}</script></head><body><div id="__nuxt" class="isolate"><!--[--><!--[--><!--[--><!--[--><!--[--><div class="@container/main"><div class="w-full max-w-(--ui-container) mx-auto px-4 sm:px-6 lg:px-8 sm:border-x border-default pt-10 relative"><!--[--><div class="flex items-center justify-center w-full p-2"><!--[--><!----><!----><nav data-collapsed="false" data-slot="root" class="relative flex gap-1.5 [&amp;&gt;div]:min-w-0 items-center justify-between bg-muted/80 backdrop-blur-sm rounded-full px-2 sm:px-4 border border-muted/50 shadow-lg shadow-neutral-950/5" aria-label="Main" data-orientation="horizontal" dir="ltr" data-reka-navigation-menu><!--[--><!--[--><!--]--><!--[--><!--[--><div style="position:relative;"><ul data-slot="list" class="isolate min-w-0 flex items-center" data-orientation="horizontal"><!--[--><!--[--><li data-menu-item data-slot="item" class="min-w-0 py-2"><!--[--><!--[--><a href="/" data-reka-collection-item data-slot="link" class="group relative w-full flex items-center gap-1.5 font-medium text-sm before:absolute before:z-[-1] before:rounded-md focus:outline-none focus-visible:outline-none dark:focus-visible:outline-none focus-visible:before:ring-inset focus-visible:before:ring-2 focus-visible:before:ring-inverted before:inset-x-px before:inset-y-0 text-muted hover:text-highlighted transition-colors data-[state=open]:text-highlighted px-2 py-1"><!--[--><!--[--><!--[--><span class="iconify i-lucide:home shrink-0 size-5 text-dimmed group-hover:text-default transition-colors group-data-[state=open]:text-default hidden" aria-hidden="true" style="" data-slot="linkLeadingIcon"></span><!--]--><span data-slot="linkLabel" class="truncate"><!--[-->Home<!--]--><!----></span><!----><!--]--><!--]--></a><!----><!--]--><!----><!--]--></li><li data-menu-item data-slot="item" class="min-w-0 py-2"><!--[--><!--[--><a href="/blog/" data-reka-collection-item data-slot="link" class="group relative w-full flex items-center gap-1.5 font-medium text-sm before:absolute before:z-[-1] before:rounded-md focus:outline-none focus-visible:outline-none dark:focus-visible:outline-none focus-visible:before:ring-inset focus-visible:before:ring-2 focus-visible:before:ring-inverted before:inset-x-px before:inset-y-0 text-muted hover:text-highlighted transition-colors data-[state=open]:text-highlighted px-2 py-1"><!--[--><!--[--><!--[--><span class="iconify i-lucide:file-text shrink-0 size-5 text-dimmed group-hover:text-default transition-colors group-data-[state=open]:text-default hidden" aria-hidden="true" style="" data-slot="linkLeadingIcon"></span><!--]--><span data-slot="linkLabel" class="truncate"><!--[-->Blog<!--]--><!----></span><!----><!--]--><!--]--></a><!----><!--]--><!----><!--]--></li><li data-menu-item data-slot="item" class="min-w-0 py-2"><!--[--><!--[--><a href="/about/" data-reka-collection-item data-slot="link" class="group relative w-full flex items-center gap-1.5 font-medium text-sm before:absolute before:z-[-1] before:rounded-md focus:outline-none focus-visible:outline-none dark:focus-visible:outline-none focus-visible:before:ring-inset focus-visible:before:ring-2 focus-visible:before:ring-inverted before:inset-x-px before:inset-y-0 text-muted hover:text-highlighted transition-colors data-[state=open]:text-highlighted px-2 py-1"><!--[--><!--[--><!--[--><span class="iconify i-lucide:user shrink-0 size-5 text-dimmed group-hover:text-default transition-colors group-data-[state=open]:text-default hidden" aria-hidden="true" style="" data-slot="linkLeadingIcon"></span><!--]--><span data-slot="linkLabel" class="truncate"><!--[-->About<!--]--><!----></span><!----><!--]--><!--]--></a><!----><!--]--><!----><!--]--></li><!--]--><!--]--></ul></div><!----><!--]--><!--]--><!--[--><!--[--><div class="size-4"></div><!--]--><!--]--><div data-slot="viewportWrapper" class="absolute top-full left-0 flex w-full justify-center"><!----><!----></div><!--]--></nav><!--]--></div><!--[--><main class="min-h-[calc(100vh-var(--ui-header-height))] relative"><!--[--><main class="min-h-[calc(100vh-var(--ui-header-height))] mt-20 px-2" style="--toc-sticky-width:1300px;"><!--[--><!--[--><!----><!----><nav data-state="closed" data-slot="root" class="z-10 bg-default/75 lg:bg-[initial] backdrop-blur -mx-4 px-4 sm:px-6 sm:-mx-6 max-h-[calc(100vh-var(--ui-header-height))] fixed bottom-20 top-45 left-[unset]! right-0 h-[unset]! w-[calc((100cqw-var(--ui-container))/2-10px)] overflow-y-auto backdrop-filter-none @max-6xl/main:hidden! px-4! mx-[unset]!"><!--[--><div data-slot="container" class="pt-4 sm:pt-6 pb-2.5 sm:pb-4.5 lg:py-8 border-b border-dashed border-default lg:border-0 flex flex-col"><!----><!--[--><button type="button" aria-controls aria-expanded="false" data-state="closed" data-slot="trigger" class="group text-sm font-semibold flex-1 flex items-center gap-1.5 py-1.5 -mt-1.5 focus-visible:outline-primary lg:hidden"><!--[--><!--[--><!--[--><!--]--><span data-slot="title" class="truncate"><!--[-->Table of Contents<!--]--></span><span data-slot="trailing" class="ms-auto inline-flex gap-1.5 items-center"><!--[--><span class="iconify i-lucide:chevron-down size-5 transform transition-transform duration-200 shrink-0 group-data-[state=open]:rotate-180 lg:hidden" aria-hidden="true" style="" data-slot="trailingIcon"></span><!--]--></span><!--]--><!--]--></button><div data-slot="content" class="data-[state=open]:animate-[collapsible-down_200ms_ease-out] data-[state=closed]:animate-[collapsible-up_200ms_ease-out] overflow-hidden focus:outline-none lg:hidden" id="reka-collapsible-content-v-0-0-3-0" hidden data-state="closed" style="--reka-collapsible-content-height:0px;--reka-collapsible-content-width:0px;"><!--v-if--></div><p data-slot="trigger" class="group text-sm font-semibold flex-1 items-center gap-1.5 py-1.5 -mt-1.5 focus-visible:outline-primary hidden lg:flex"><!--[--><!--[--><!--]--><span data-slot="title" class="truncate"><!--[-->Table of Contents<!--]--></span><span data-slot="trailing" class="ms-auto inline-flex gap-1.5 items-center"><!--[--><span class="iconify i-lucide:chevron-down size-5 transform transition-transform duration-200 shrink-0 group-data-[state=open]:rotate-180 lg:hidden" aria-hidden="true" style="" data-slot="trailingIcon"></span><!--]--></span><!--]--></p><div data-slot="content" class="data-[state=open]:animate-[collapsible-down_200ms_ease-out] data-[state=closed]:animate-[collapsible-up_200ms_ease-out] overflow-hidden focus:outline-none hidden lg:flex"><!----><!--[--><ul class="min-w-0"><!--[--><li class="min-w-0"><a href="#initial-dom-based-attempt" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Initial DOM Based Attempt</span><!--]--></a><!----></li><li class="min-w-0"><a href="#switching-to-pixijs" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Switching to Pixi.js</span><!--]--></a><!----></li><li class="min-w-0"><a href="#actual-usage-expectations" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Actual Usage Expectations</span><!--]--></a><!----></li><li class="min-w-0"><a href="#limits-reached" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Limits Reached</span><!--]--></a><!----></li><li class="min-w-0"><a href="#avoiding-accidental-optimizations" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Avoiding Accidental Optimizations</span><!--]--></a><!----></li><li class=""><a href="#optimizations" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Optimizations</span><!--]--></a><ul class="ms-3"><!--[--><li class="min-w-0"><a href="#decoupled-reactive-lifecycle" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Decoupled Reactive Lifecycle</span><!--]--></a><!----></li><li class="min-w-0"><a href="#culling" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Culling</span><!--]--></a><!----></li><li class="min-w-0"><a href="#manual-texture-baking" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Manual Texture Baking</span><!--]--></a><!----></li><li class="min-w-0"><a href="#dynamic-level-of-detail-lod" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Dynamic Level of Detail (LOD)</span><!--]--></a><!----></li><li class="min-w-0"><a href="#using-bitmap-text" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Using Bitmap Text</span><!--]--></a><!----></li><li class="min-w-0"><a href="#loading-and-on-demand-text-generation" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Loading and On-Demand Text Generation</span><!--]--></a><!----></li><li class="min-w-0"><a href="#background-idle-generation" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Background Idle Generation</span><!--]--></a><!----></li><li class="min-w-0"><a href="#faster-text-truncation" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Faster Text Truncation</span><!--]--></a><!----></li><!--]--></ul></li><li class=""><a href="#further-potential-optimizations" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Further Potential Optimizations</span><!--]--></a><ul class="ms-3"><!--[--><li class="min-w-0"><a href="#pooling" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Pooling</span><!--]--></a><!----></li><li class="min-w-0"><a href="#others" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Others</span><!--]--></a><!----></li><li class="min-w-0"><a href="#usability-improvements-future-features" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">Usability Improvements + Future Features</span><!--]--></a><!----></li><li class="min-w-0"><a href="#avoid" data-slot="link" class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted hover:text-default transition-colors"><!--[--><span data-slot="linkText" class="truncate">AVOID</span><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--]--></div><!--]--><!----></div><!--]--></nav><!--]--><!--[--><div type="button" aria-haspopup="dialog" aria-expanded="false" data-state="closed" class="sticky z-10 top-10 right-0 bottom-[unset] @min-6xl/main:hidden flex items-center justify-end"><div class="p-3"><!--[--><!--[--><button type="button" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors px-2.5 py-1.5 text-sm gap-1.5 ring ring-inset ring-accented text-default bg-elevated hover:bg-accented/75 active:bg-accented/75 disabled:bg-elevated aria-disabled:bg-elevated focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted"><!--[--><!--[--><!----><!--]--><!--[--><span data-slot="label" class="truncate">TOC</span><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--></div></div><!--v-if--><!--]--><div class="w-full max-w-(--ui-container) mx-auto px-4 sm:px-6 lg:px-8 relative min-h-screen"><!--[--><div data-slot="root" class="flex flex-col lg:grid lg:grid-cols-10 lg:gap-10"><!----><div data-slot="center" class="lg:col-span-10"><!--[--><a href="/blog/" class="focus-visible:outline-primary text-muted hover:text-default transition-colors text-sm flex items-center gap-1"><!--[--><!--[--><span class="iconify i-lucide:chevron-left" aria-hidden="true" style=""></span> Blog <!--]--><!--]--></a><div class="flex flex-col gap-3 mt-8"><div class="flex text-xs text-muted items-center justify-center gap-2"><span>Feb 2, 2026</span></div><video src="/thumbs/infinite-canvas-thumb.mp4" muted autoplay loop class="rounded-lg w-full h-[300px] object-contain object-center"></video><h1 class="text-4xl text-center font-medium max-w-3xl mx-auto mt-4">Handling Thousands Cards on an Infinite Canvas</h1><p class="text-muted text-center max-w-2xl mx-auto">A deep dive into the engineering behind Pyramid&#39;s infinite canvas and how to handle high-density layouts without sacrificing responsiveness â€” it covers texture baking, custom culling, background idle generation, efficient text handling, text truncation, and the dynamic LOD states required for massive datasets.</p></div><div class="mt-8 pb-24 space-y-12 max-w-3xl mx-auto"><!--[--><div data-content-id="blog/blog/performant-pixi-infinite-canvas.md"><p class="my-5 leading-7 text-pretty"><!--[-->I&#39;m working on an app, <!--[--><a href="https://pyramidnotes.com" rel="nofollow" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->Pyramid Notes<!--]--><!--]--><!--]--></a><!--]-->, which will have an infinite canvas.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->It will have two modes mainly:<!--]--></p><ul class="list-disc ps-6 my-5 marker:text-(--ui-border-accented)"><!--[--><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->freeform mode - users can drop and place cards everywhere.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->&quot;structured&quot; mode - with a preset layout. In this initial version, the layout will is a visualization of note tags (they function more like folders).<!--]--></li><!--]--></ul><h2 id="initial-dom-based-attempt" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#initial-dom-based-attempt" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Initial DOM Based Attempt<!--]--></a></h2><p class="my-5 leading-7 text-pretty"><!--[-->I had initially planned to create an HTML based infinite canvas as it&#39;s just easier to get started with, but the DOM approach has a lot of lag, <em><!--[-->especially<!--]--></em> when zooming, which was a deal breaker. I <em><!--[-->needed<!--]--></em> really fast zoom in/out performance.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->The html version <em><!--[-->was<!--]--></em> a bit naively coded, but the same approach with pixi.js (webgl canvas lib) was 10x more performant. Properly optimized HTML starts lagging at around 1000 notes, my initial quick canvas implementation started lagging at around 10,000.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Here is a link to <!--[--><a href="https://www.tldraw.com/f/cTRjZahSxPYiXwM6Ws3yH?d=v10977.-651.19434.9393.page" rel="nofollow" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->1000 notes on tldraw<!--]--><!--]--><!--]--></a><!--]--> (and the <!--[--><a href="https://www.tldraw.com/f/mEG6km2LEfSaAn7TD-JOO?d=v16327.1343.6034.3497.page" rel="nofollow" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->blank version<!--]--><!--]--><!--]--></a><!--]-->) which seems well optimized so you can see it&#39;s not me with a bad implementation.<!--]--></p><video autoplay controls muted src="/posts/infinite-canvas-tldraw-comparison.mp4"></video><p class="my-5 leading-7 text-pretty"><!--[-->There&#39;s just like a very sluggish feeling, especially zooming. I suspect the culprit might be shadows because they seem to get turned on/off at the point zoom feels sluggish, but I don&#39;t think there&#39;s any way around that. The blank version is clearly faster so some of it is the text itself rendering when very zoomed out, but I tried different lod levels in DOM, and the zoom range where they change <em><!--[-->feels<!--]--></em> slow. Sometimes canvas also skips a frame at that point but it doesn&#39;t feel nearly as bad.<!--]--></p><h2 id="switching-to-pixijs" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#switching-to-pixijs" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Switching to Pixi.js<!--]--></a></h2><p class="my-5 leading-7 text-pretty"><!--[-->Once I switched to <!--[--><a href="https://pixijs.com/8.x/guides/getting-started/introduction" rel="nofollow" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->pixi.js<!--]--><!--]--><!--]--></a><!--]-->, I was way too tempted to properly test the limits and see how many notes I could get to render.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I setup some basic culling + lod states, and changed the layout structure (from flat to a tree) and got to around 50,000 notes before serious lagging, but I wanted to find the real limit. In part out of curiosity, in part to not attempt to load so many (users can limit what they load with a search filter).<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Mind you, the 50,000 at that point was a bit of a lie because the notes weren&#39;t unique. I also made this mistake when I initially tweeted about reaching 100,000. See below for more details.<!--]--></p><h2 id="actual-usage-expectations" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#actual-usage-expectations" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Actual Usage Expectations<!--]--></a></h2><p class="my-5 leading-7 text-pretty"><!--[-->From what I&#39;ve researched and from the number of notes I have myself, I expect the average user to probably have ~1000-10,000 notes. As a maximum I can see maybe some power users will have 20-50,000.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I don&#39;t expect &gt;50,000 notes, but it is possible, depending on how they organize them, that they might need to render more since notes can appear more than once in the structured tree.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I do not expect freeform mode to get nearly as big as notes must be added by hand.<!--]--></p><div class="md-emphasis-block block bg-primary-500/20 border-x-[calc(var(--spacing)*2)] border-primary-500/30 p-4 -mx-6"><!--[--><h2 id="limits-reached" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#limits-reached" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Limits Reached<!--]--></a></h2><p class="my-5 leading-7 text-pretty"><!--[-->I ended up reaching about 60,000 unique cards before there started to be some minor lag (still snappier than the DOM approach), and 90,000 unique cards before it started to feel too sluggish. I reached 100,000 a few times, but past 95,000 the page would occasionally crash as it finished generating all the text.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->One can sacrifice a bit of LOD to reach smoother 100,000, but I didn&#39;t like it. I think it&#39;s best to just warn the user to use a filter past 60,000. If they want to risk it they can (on chrome the crashes sometimes required I restart the entire browser ðŸ’€).<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Here&#39;s what 100,000 feels like, you can see it&#39;s starting to struggle:<!--]--></p><video autoplay controls muted src="/posts/inifite-canvas-100000.mp4"></video><p class="my-5 leading-7 text-pretty"><!--[-->Here&#39;s 50,000 which feels super snappy (this was the thumb). 60,000 starts to occasionally skip a frame on zoom but still feels fast:<!--]--></p><video autoplay controls muted src="/posts/infinite-canvas-50000.mp4"></video><p class="my-5 leading-7 text-pretty"><!--[-->I&#39;m actually sure we could go <em><!--[-->further<!--]--></em> (see <!--[--><a href="#pooling" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->#pooling<!--]--><!--]--><!--]--></a><!--]-->) but I don&#39;t think the increase in code complexity is worth it.<!--]--></p><!--]--></div><h2 id="avoiding-accidental-optimizations" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#avoiding-accidental-optimizations" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Avoiding Accidental Optimizations<!--]--></a></h2><p class="my-5 leading-7 text-pretty"><!--[-->It&#39;s easy to accidentally get performance speedups from how one sets up the test scenario.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->In this case initially I only had 1000 unique notes and initially they were just repeated to get 50,000/100,000. I started like this because generating 50,000 real random documents is currently still super slow, I can only do about 300 docs max at a time. This is because generating a note requires generating a random prosemirror document and this was tricky to even get working.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Now Pixi.js does caching internally to speed up scenerios with duplicate cards like this so I had to make adjustments to avoid all unreasonably performance optimizations and find the real number of <em><!--[-->unique<!--]--></em> notes I could render.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I say unreasonable because some repitition is expected in every day use. To control the uniqueness and take more <em><!--[-->reasonable<!--]--></em> advantage of pixi&#39;s internal caches (it has per word (temporary), and per text), I generated 170,000 unique &quot;words&quot; (they&#39;re just random characters/symbols) and replaced the card text with random slices from those words.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Why 170,000? This is about how many words are actively in use in the english language. They are distributed randomly here, unlike a realistic distribution where some words appear way more than others, but that just means real usage will be slightly faster.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Here&#39;s the code I used:<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="s7zQu">import</span><span class="sMK4o"> {</span><span class="sTEyZ"> faker</span><span class="sMK4o"> }</span><span class="s7zQu"> from</span><span class="sMK4o"> &quot;</span><span class="sfazB">@faker-js/faker</span><span class="sMK4o">&quot;
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span class="s7zQu">export</span><span class="spNyl"> const</span><span class="sTEyZ"> perfUtilsConfig </span><span class="sMK4o">=</span><span class="sMK4o"> {
</span></span><span class="line" line="4"><span class="swJcz">    minWordLength</span><span class="sMK4o">:</span><span class="sbssI"> 3</span><span class="sMK4o">,
</span></span><span class="line" line="5"><span class="swJcz">    maxWordLength</span><span class="sMK4o">:</span><span class="sbssI"> 10</span><span class="sMK4o">,
</span></span><span class="line" line="6"><span class="swJcz">    uniqueWords</span><span class="sMK4o">:</span><span class="sbssI"> 170000</span><span class="sMK4o">,
</span></span><span class="line" line="7"><span class="swJcz">    uniqueNoteCount</span><span class="sMK4o">:</span><span class="sbssI"> 90000
</span></span><span class="line" line="8"><span class="sMK4o">}
</span></span><span class="line" line="9"><span class="spNyl">const</span><span class="sTEyZ"> seenWords </span><span class="sMK4o">=</span><span class="sMK4o"> new</span><span class="s2Zo4"> Set</span><span class="sMK4o">&lt;</span><span class="sBMFI">string</span><span class="sMK4o">&gt;</span><span class="sTEyZ">()
</span></span><span class="line" line="10"><span class="s7zQu">export</span><span class="spNyl"> function</span><span class="s2Zo4"> createWords</span><span class="sMK4o">(</span><span class="sHdIc">count</span><span class="sMK4o">:</span><span class="sBMFI"> number</span><span class="sMK4o">)</span><span class="sMK4o"> {
</span></span><span class="line" line="11"><span class="spNyl">    const</span><span class="sTEyZ"> res</span><span class="sMK4o"> =</span><span class="sTEyZ"> Array</span><span class="sMK4o">.</span><span class="s2Zo4">from</span><span class="swJcz">(
</span></span><span class="line" line="12"><span class="sMK4o">        {</span><span class="swJcz"> length</span><span class="sMK4o">:</span><span class="sTEyZ"> count</span><span class="sMK4o"> },
</span></span><span class="line" line="13"><span class="sMK4o">        ()</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> {
</span></span><span class="line" line="14"><span class="sHwdD">            // i know faker has word generation, but I want random symbols included
</span></span><span class="line" line="15"><span class="spNyl">            let</span><span class="sTEyZ"> word</span><span class="sMK4o"> =</span><span class="sTEyZ"> faker</span><span class="sMK4o">.</span><span class="sTEyZ">string</span><span class="sMK4o">.</span><span class="s2Zo4">sample</span><span class="swJcz">(</span><span class="sMK4o">{</span><span class="swJcz"> min</span><span class="sMK4o">:</span><span class="sTEyZ"> perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">minWordLength</span><span class="sMK4o">,</span><span class="swJcz"> max</span><span class="sMK4o">:</span><span class="sTEyZ"> perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">maxWordLength</span><span class="sMK4o"> }</span><span class="swJcz">)
</span></span><span class="line" line="16"><span class="s7zQu">            while</span><span class="swJcz"> (</span><span class="sTEyZ">seenWords</span><span class="sMK4o">.</span><span class="s2Zo4">has</span><span class="swJcz">(</span><span class="sTEyZ">word</span><span class="swJcz">)) </span><span class="sMK4o">{
</span></span><span class="line" line="17"><span class="sTEyZ">                word</span><span class="sMK4o"> =</span><span class="sTEyZ"> faker</span><span class="sMK4o">.</span><span class="sTEyZ">string</span><span class="sMK4o">.</span><span class="s2Zo4">sample</span><span class="swJcz">(</span><span class="sMK4o">{</span><span class="swJcz"> min</span><span class="sMK4o">:</span><span class="sTEyZ"> perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">minWordLength</span><span class="sMK4o">,</span><span class="swJcz"> max</span><span class="sMK4o">:</span><span class="sTEyZ"> perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">maxWordLength</span><span class="sMK4o"> }</span><span class="swJcz">)
</span></span><span class="line" line="18"><span class="sMK4o">            }
</span></span><span class="line" line="19"><span class="s7zQu">            return</span><span class="sTEyZ"> word
</span></span><span class="line" line="20"><span class="sMK4o">        }
</span></span><span class="line" line="21"><span class="swJcz">    )</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sMK4o"> &quot;</span><span class="swJcz">)
</span></span><span class="line" line="22"><span class="s7zQu">    return</span><span class="sTEyZ"> res
</span></span><span class="line" line="23"><span class="sMK4o">}
</span></span><span class="line" line="24"><span class="sHwdD">// estimated number of english words in active use
</span></span><span class="line" line="25"><span class="spNyl">const</span><span class="sTEyZ"> additionalText </span><span class="sMK4o">=</span><span class="s2Zo4"> createWords</span><span class="sTEyZ">(perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">uniqueWords)
</span></span><span class="line" line="26"><span class="sTEyZ">seenWords</span><span class="sMK4o">.</span><span class="s2Zo4">clear</span><span class="sTEyZ">()
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span class="spNyl">const</span><span class="sTEyZ"> noteSlicePoints </span><span class="sMK4o">=</span><span class="sTEyZ"> Array</span><span class="sMK4o">.</span><span class="s2Zo4">from</span><span class="sTEyZ">(</span><span class="sMK4o">{</span><span class="swJcz"> length</span><span class="sMK4o">:</span><span class="sTEyZ"> perfUtilsConfig</span><span class="sMK4o">.</span><span class="sTEyZ">uniqueNoteCount </span><span class="sMK4o">}</span><span class="sTEyZ">)</span><span class="sMK4o">.</span><span class="s2Zo4">map</span><span class="sTEyZ">(</span><span class="sHdIc">i</span><span class="spNyl"> =&gt;</span><span class="sTEyZ"> Math</span><span class="sMK4o">.</span><span class="s2Zo4">floor</span><span class="sTEyZ">(Math</span><span class="sMK4o">.</span><span class="s2Zo4">random</span><span class="sTEyZ">() </span><span class="sMK4o">*</span><span class="sTEyZ"> additionalText</span><span class="sMK4o">.</span><span class="sTEyZ">length))
</span></span><span class="line" line="29"><span class="sHwdD">// slice random bits from the text
</span></span><span class="line" line="30"><span class="s7zQu">export</span><span class="spNyl"> function</span><span class="s2Zo4"> generateText</span><span class="sMK4o">(</span><span class="sHdIc">max</span><span class="sMK4o">:</span><span class="sBMFI"> number</span><span class="sMK4o">)</span><span class="sMK4o"> {
</span></span><span class="line" line="31"><span class="spNyl">    const</span><span class="sTEyZ"> cut</span><span class="sMK4o"> =</span><span class="sTEyZ"> noteSlicePoints</span><span class="swJcz">[</span><span class="sTEyZ">Math</span><span class="sMK4o">.</span><span class="s2Zo4">floor</span><span class="swJcz">(</span><span class="sTEyZ">Math</span><span class="sMK4o">.</span><span class="s2Zo4">random</span><span class="swJcz">() </span><span class="sMK4o">*</span><span class="sTEyZ"> noteSlicePoints</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="swJcz">)]
</span></span><span class="line" line="32"><span class="spNyl">    const</span><span class="sTEyZ"> res</span><span class="sMK4o"> =</span><span class="sTEyZ"> additionalText</span><span class="sMK4o">.</span><span class="s2Zo4">slice</span><span class="swJcz">(</span><span class="sTEyZ">cut</span><span class="sMK4o">,</span><span class="sTEyZ"> cut</span><span class="sMK4o"> +</span><span class="sTEyZ"> max</span><span class="swJcz">)
</span></span><span class="line" line="33"><span class="s7zQu">    return</span><span class="sTEyZ"> res
</span></span><span class="line" line="34"><span class="sMK4o">}
</span></span></code><!--]--></pre></div><!--]--></details><p class="my-5 leading-7 text-pretty"><!--[-->You will see in the top right of videos, in the debug details it sayse <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->Uniqueness: [count]<!--]--></code>, this is the number of unique cards generated. <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->Card Count<!--]--></code> is the number of cards in the full tree. <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->In View<!--]--></code> will show how many cards are actually in view.<!--]--></p><h2 id="optimizations" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#optimizations" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Optimizations<!--]--></a></h2><h3 id="decoupled-reactive-lifecycle" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#decoupled-reactive-lifecycle" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Decoupled Reactive Lifecycle<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->The rendering loop is decoupled from vueâ€™s reactivity. Instead of immediately reacting to every state change, we set dirty flags and do the appropriate action on the next tick.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I used a class (I did not have a good experience trying to figure out pixi-vue unfortunately) so watchers created here must be properly cleaned up (vue is not automatically aware of them like it is in SFCs).<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="spNyl">class</span><span class="sBMFI"> PixiCanvas</span><span class="sMK4o"> {
</span></span><span class="line" line="2"><span class="swJcz">    toDestroy</span><span class="sMK4o"> =</span><span class="sTEyZ"> []
</span></span><span class="line" line="3"><span class="swJcz">    onMounted</span><span class="sMK4o">()</span><span class="sMK4o"> {
</span></span><span class="line" line="4"><span class="spNyl">        let</span><span class="sTEyZ"> layoutDirty</span><span class="sMK4o"> =</span><span class="sfNiH"> true
</span></span><span class="line" line="5"><span class="sMK4o">        this.</span><span class="sTEyZ">toDestroy</span><span class="sMK4o">.</span><span class="s2Zo4">push</span><span class="swJcz">(</span><span class="s2Zo4">watch</span><span class="swJcz">(</span><span class="sMK4o">this.</span><span class="sTEyZ">layout</span><span class="sMK4o">,</span><span class="sMK4o"> ()</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> {
</span></span><span class="line" line="6"><span class="sTEyZ">            layoutDirty</span><span class="sMK4o"> =</span><span class="sfNiH"> true
</span></span><span class="line" line="7"><span class="sMK4o">        }</span><span class="swJcz">)</span><span class="sMK4o">.</span><span class="sTEyZ">stop</span><span class="swJcz">)
</span></span><span class="line" line="8"><span class="sTEyZ">        app</span><span class="sMK4o">.</span><span class="sTEyZ">ticker</span><span class="sMK4o">.</span><span class="s2Zo4">add</span><span class="swJcz">(</span><span class="sMK4o">()</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> {
</span></span><span class="line" line="9"><span class="s7zQu">            if</span><span class="swJcz"> (</span><span class="sTEyZ">layoutDirty</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="10"><span class="sHwdD">                // ...
</span></span><span class="line" line="11"><span class="sMK4o">            }
</span></span><span class="line" line="12"><span class="sMK4o">        }</span><span class="swJcz">)
</span></span><span class="line" line="13"><span class="sMK4o">    }
</span></span><span class="line" line="14"><span class="sTEyZ">    
</span></span><span class="line" line="15"><span class="swJcz">    destroy</span><span class="sMK4o">()</span><span class="sMK4o"> {
</span></span><span class="line" line="16"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sMK4o">!this.</span><span class="sTEyZ">initialized</span><span class="swJcz">) </span><span class="s7zQu">throw</span><span class="sMK4o"> new</span><span class="s2Zo4"> Error</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">Pixi not initialized, cannot destroy.</span><span class="sMK4o">&quot;</span><span class="swJcz">)
</span></span><span class="line" line="17"><span class="s7zQu">        for</span><span class="swJcz"> (</span><span class="spNyl">const</span><span class="sTEyZ"> item</span><span class="sMK4o"> of</span><span class="sMK4o"> this.</span><span class="sTEyZ">toDestroy</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="18"><span class="s2Zo4">            item</span><span class="swJcz">()
</span></span><span class="line" line="19"><span class="sMK4o">        }
</span></span><span class="line" line="20"><span class="sHwdD">        // textures should also be destroyed here
</span></span><span class="line" line="21"><span class="sMK4o">        this.</span><span class="sTEyZ">app</span><span class="sMK4o">.</span><span class="s2Zo4">destroy</span><span class="swJcz">()
</span></span><span class="line" line="22"><span class="sMK4o">    }
</span></span><span class="line" line="23"><span class="sMK4o">}
</span></span></code><!--]--></pre></div><!--]--></details><h3 id="culling" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#culling" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Culling<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->Naive culling is not enough, checking thousands of notes is too expensive.<!--]--></p><h4 id="take-advantage-of-existing-structure" class="text-lg text-highlighted font-bold mt-6 mb-2 scroll-mt-[calc(24px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(24px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary"><a href="#take-advantage-of-existing-structure" class=""><!--[-->Take Advantage of Existing Structure<!--]--></a></h4><p class="my-5 leading-7 text-pretty"><!--[-->If your data is structured in any form of tree, take advantage of that even if it makes it harder to traverse/update the tree.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->If a parent container is not visible, all children will be skipped making things way faster.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->For the freeform mode, I plan to place them inside invisible containers/buckets to simulate this. The freeform layout will be saveable and we can cache the notes each bucket contains and we would only need to update this if a user moves a note.<!--]--></p><h4 id="use-a-custom-algorithm-if-needed" class="text-lg text-highlighted font-bold mt-6 mb-2 scroll-mt-[calc(24px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(24px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary"><a href="#use-a-custom-algorithm-if-needed" class=""><!--[-->Use a Custom Algorithm If Needed<!--]--></a></h4><p class="my-5 leading-7 text-pretty"><!--[-->I used a custom algorithm for two reasons:<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I already know how big the viewport will be before pixi loads. I can do the culling beforehand.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I know the constraints of my layout. Nested areas are always contained within their parent, and notes are always contained by their areas. We can make optimizations based on this. For example, if the viewport is inside an area, only that area needs to be checked. All other areas can be immediately skipped.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Pixi does not do this internally because children can exist outside of their parent bounds.<!--]--></p><h3 id="manual-texture-baking" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#manual-texture-baking" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Manual Texture Baking<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->This example demonstrates how to manually instruct the renderer to bake any display object (like a <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->Container<!--]--></code> or <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->Graphics<!--]--></code> object) into a reusable texture. This is highly efficient as the complex object is drawn only once.<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="sHwdD">// example for the full LOD card background
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span class="sHwdD">// this is called once, then only again if the theme ref changes
</span></span><span class="line" line="4"><span class="s2Zo4">createTextures</span><span class="sTEyZ">() </span><span class="sMK4o">{
</span></span><span class="line" line="5"><span class="sHwdD">    // careful to give enough space if using shadows
</span></span><span class="line" line="6"><span class="spNyl">    const</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> =</span><span class="sbssI"> 4</span><span class="sMK4o"> *</span><span class="sbssI"> 4
</span></span><span class="line" line="7"><span class="spNyl">    const</span><span class="sTEyZ"> container</span><span class="sMK4o"> =</span><span class="sMK4o"> new</span><span class="s2Zo4"> Container</span><span class="swJcz">()
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span class="spNyl">    const</span><span class="sTEyZ"> shadowGraphic</span><span class="sMK4o"> =</span><span class="sMK4o"> new</span><span class="s2Zo4"> Graphics</span><span class="swJcz">()
</span></span><span class="line" line="10"><span class="sMK4o">        .</span><span class="s2Zo4">roundRect</span><span class="swJcz">(</span><span class="sTEyZ">shadowPadding</span><span class="sMK4o">,</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardWidth</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardHeight</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardRounding</span><span class="swJcz">)
</span></span><span class="line" line="11"><span class="sMK4o">        .</span><span class="s2Zo4">fill</span><span class="swJcz">(</span><span class="sMK4o">{
</span></span><span class="line" line="12"><span class="swJcz">            color</span><span class="sMK4o">:</span><span class="sMK4o"> this.</span><span class="sTEyZ">theme</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o">.</span><span class="sTEyZ">note</span><span class="sMK4o">.</span><span class="sTEyZ">shadow</span><span class="sMK4o">,
</span></span><span class="line" line="13"><span class="swJcz">            alpha</span><span class="sMK4o">:</span><span class="sMK4o"> this.</span><span class="sTEyZ">theme</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o">.</span><span class="sTEyZ">note</span><span class="sMK4o">.</span><span class="sTEyZ">shadowAlpha
</span></span><span class="line" line="14"><span class="sMK4o">        }</span><span class="swJcz">)
</span></span><span class="line" line="15"><span class="sTEyZ">    shadowGraphic</span><span class="sMK4o">.</span><span class="sTEyZ">filters</span><span class="sMK4o"> =</span><span class="swJcz"> [</span><span class="sMK4o">new</span><span class="s2Zo4"> BlurFilter</span><span class="swJcz">(</span><span class="sMK4o">{</span><span class="swJcz"> strength</span><span class="sMK4o">:</span><span class="sbssI"> 4</span><span class="sMK4o">,</span><span class="swJcz"> quality</span><span class="sMK4o">:</span><span class="sbssI"> 3</span><span class="sMK4o">,</span><span class="swJcz"> resolution</span><span class="sMK4o">:</span><span class="sTEyZ"> window</span><span class="sMK4o">.</span><span class="sTEyZ">devicePixelRatio</span><span class="sMK4o"> }</span><span class="swJcz">)]
</span></span><span class="line" line="16"><span class="sTEyZ">    container</span><span class="sMK4o">.</span><span class="s2Zo4">addChild</span><span class="swJcz">(</span><span class="sTEyZ">shadowGraphic</span><span class="swJcz">)
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span class="spNyl">    const</span><span class="sTEyZ"> cardGraphic</span><span class="sMK4o"> =</span><span class="sMK4o"> new</span><span class="s2Zo4"> Graphics</span><span class="swJcz">()
</span></span><span class="line" line="19"><span class="sMK4o">        .</span><span class="s2Zo4">roundRect</span><span class="swJcz">(</span><span class="sTEyZ">shadowPadding</span><span class="sMK4o">,</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> -</span><span class="sbssI"> 2</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardWidth</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardHeight</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardRounding</span><span class="swJcz">)
</span></span><span class="line" line="20"><span class="sMK4o">        .</span><span class="s2Zo4">fill</span><span class="swJcz">(</span><span class="sMK4o">{</span><span class="swJcz"> color</span><span class="sMK4o">:</span><span class="sMK4o"> this.</span><span class="sTEyZ">theme</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o">.</span><span class="sTEyZ">note</span><span class="sMK4o">.</span><span class="sTEyZ">bg</span><span class="sMK4o"> }</span><span class="swJcz">)
</span></span><span class="line" line="21"><span class="sTEyZ">    container</span><span class="sMK4o">.</span><span class="s2Zo4">addChild</span><span class="swJcz">(</span><span class="sTEyZ">cardGraphic</span><span class="swJcz">)
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span class="sMK4o">    this.</span><span class="sTEyZ">cardFullTexture</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="sTEyZ">app</span><span class="sMK4o">.</span><span class="sTEyZ">renderer</span><span class="sMK4o">.</span><span class="s2Zo4">generateTexture</span><span class="swJcz">(</span><span class="sMK4o">{
</span></span><span class="line" line="24"><span class="swJcz">        target</span><span class="sMK4o">:</span><span class="sTEyZ"> container</span><span class="sMK4o">,
</span></span><span class="line" line="25"><span class="swJcz">        frame</span><span class="sMK4o">:</span><span class="sMK4o"> new</span><span class="s2Zo4"> Rectangle</span><span class="swJcz">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sbssI"> 0</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardWidth</span><span class="sMK4o"> +</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> *</span><span class="sbssI"> 2</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardHeight</span><span class="sMK4o"> +</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> *</span><span class="sbssI"> 2</span><span class="swJcz">)
</span></span><span class="line" line="26"><span class="sMK4o">    }</span><span class="swJcz">)
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span class="sHwdD">    // save the texture for later use
</span></span><span class="line" line="29"><span class="sMK4o">    this.</span><span class="sTEyZ">cardFullTexture</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="sTEyZ">app</span><span class="sMK4o">.</span><span class="sTEyZ">renderer</span><span class="sMK4o">.</span><span class="s2Zo4">generateTexture</span><span class="swJcz">(</span><span class="sMK4o">{
</span></span><span class="line" line="30"><span class="swJcz">        target</span><span class="sMK4o">:</span><span class="sTEyZ"> container</span><span class="sMK4o">,
</span></span><span class="line" line="31"><span class="swJcz">        frame</span><span class="sMK4o">:</span><span class="sMK4o"> new</span><span class="s2Zo4"> Rectangle</span><span class="swJcz">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sbssI"> 0</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardWidth</span><span class="sMK4o"> +</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> *</span><span class="sbssI"> 2</span><span class="sMK4o">,</span><span class="sMK4o"> this.</span><span class="sTEyZ">config</span><span class="sMK4o">.</span><span class="sTEyZ">cardHeight</span><span class="sMK4o"> +</span><span class="sTEyZ"> shadowPadding</span><span class="sMK4o"> *</span><span class="sbssI"> 2</span><span class="swJcz">)
</span></span><span class="line" line="32"><span class="sMK4o">    }</span><span class="swJcz">)
</span></span><span class="line" line="33"><span class="sMK4o">}
</span></span><span class="line" line="34"><span emptylineplaceholder="true">
</span></span><span class="line" line="35"><span class="sHwdD">// later during the actual card creation:
</span></span><span class="line" line="36"><span class="spNyl">const</span><span class="sTEyZ"> cardSprite </span><span class="sMK4o">=</span><span class="sMK4o"> new</span><span class="s2Zo4"> Sprite</span><span class="sTEyZ">(</span><span class="sMK4o">this.</span><span class="sTEyZ">cardFullTexture)
</span></span></code><!--]--></pre></div><!--]--></details><p class="my-5 leading-7 text-pretty"><!--[-->Do NOT attempt to cache the full card, only the background, see <!--[--><a href="#avoid" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->#avoid<!--]--><!--]--><!--]--></a><!--]-->.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->This is a bit more complicated for images. I have not added attachments yet, so that will be a problem for later.<!--]--></p><h3 id="dynamic-level-of-detail-lod" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#dynamic-level-of-detail-lod" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Dynamic Level of Detail (LOD)<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->At full zoom cards show their titles and a short summary. Both require text wrapping and truncation which is <em><!--[-->very<!--]--></em> expensive.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Past a certain zoom point cards become unreadable so thereâ€™s no point trying to render the text which is very expensive. We can just a simple skeleton, no text. And past that we have two options:<!--]--></p><ul class="list-disc ps-6 my-5 marker:text-(--ui-border-accented)"><!--[--><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->If the app has some other large features we can visualize (in this case cards exist bounding areas in &quot;structured&quot; mode), we can render those instead.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->We can render a very small single color rectangle. Again, we can cache this. This is slower than rendering some larger feature, so avoid at all costs.<!--]--></li><!--]--></ul><p class="my-5 leading-7 text-pretty"><!--[-->Using this strategy we can fit roughly 10,000 skeleton cards in view or 1000 full-view cards.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->This with the full card zoom cut off point being <em><!--[-->past<!--]--></em> the point that I canâ€™t read it on a 4k screen (with the canvas resolution set to <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->window.devicePixelRatio<!--]--></code>) which is the worst case scenario.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->So the cutoff could be increased. It wouldn&#39;t look as nice though because even when we can&#39;t read the text, we can still get a sense of which note is which. Another option is to only hide the summary initially and only later the text.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->In all cases, I will be adding a show-on-hover feature so users can quickly read any card they&#39;re hovering over.<!--]--></p><h3 id="using-bitmap-text" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#using-bitmap-text" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Using Bitmap Text<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->As Pixi themselves suggest, use BitmapText instead of Text. <em><!--[--><strong><!--[-->This is absolutely vital past around 50,000 cards.<!--]--></strong><!--]--></em> It now supports word wrapping and it&#39;s easy to generate from a font, so it should suffice for most needs.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->The only drawback is it&#39;s more expensive for languages with a lot of symbols (like chinese). I did a quick tests though and did not see much of a difference. Canvas still felt smooth enough and memory did not jump excessively. So good signs.<!--]--></p><h3 id="loading-and-on-demand-text-generation" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#loading-and-on-demand-text-generation" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Loading and On-Demand Text Generation<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->If we tried to naively load and naively truncate (see below) the text of 100,000 cards on load it would take nearly 30 seconds with all optimizations.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Instead, on load, the card layout is created without any text. When the user zooms we generate the text on demand only when they need the full text LOD.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->The generation is limited per so we donâ€™t attempt to create the text for 1000 cards all at once.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->We check how much time we have left and hand that ms budge over to <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->generateCardText<!--]--></code> which will handle not exceeding it.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Batching like this also helps give the user a visual indication that cards <em><!--[-->are<!--]--></em> getting loaded.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Full example combined with idle generation below.<!--]--></p><h3 id="background-idle-generation" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#background-idle-generation" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Background Idle Generation<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->The canvas loads zoomed out. This gives us some time, between load, and the user zooming/panning to where they want. We can use <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->requestIdleCallback<!--]--></code> to start generating the card text regardless of visibility. This means for most users (less than &lt; 10000 cards which take 3 seconds to load) they probably wonâ€™t even see the text get generated, itâ€™ll just be there.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Here&#39;s the code combining the on demand generation with the idle generation.<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="s2Zo4">onMounted</span><span class="sTEyZ">() </span><span class="sMK4o">{
</span></span><span class="line" line="2"><span class="sHwdD">    // ... initial setup
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span class="sHwdD">    // visibilityDirty and docsDirty are set by vue watchers
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span class="sTEyZ">    app</span><span class="sMK4o">.</span><span class="sTEyZ">ticker</span><span class="sMK4o">.</span><span class="s2Zo4">add</span><span class="swJcz">(</span><span class="sMK4o">()</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> {
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span class="sMK4o">        this.</span><span class="s2Zo4">updateLodState</span><span class="swJcz">() </span><span class="sHwdD">// calculates the lod state
</span></span><span class="line" line="9"><span class="spNyl">        const</span><span class="sTEyZ"> canGenerateText</span><span class="sMK4o"> =</span><span class="sMK4o"> !</span><span class="sTEyZ">firstTick</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> this.</span><span class="sTEyZ">lodState</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">full</span><span class="sMK4o">&quot;</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">.</span><span class="sTEyZ">size</span><span class="sMK4o"> &gt;</span><span class="sbssI"> 0
</span></span><span class="line" line="10"><span class="spNyl">        const</span><span class="sTEyZ"> start</span><span class="sMK4o"> =</span><span class="sTEyZ">  canGenerateText</span><span class="sMK4o"> ?</span><span class="sTEyZ"> performance</span><span class="sMK4o">.</span><span class="s2Zo4">now</span><span class="swJcz">() </span><span class="sMK4o">:</span><span class="sMK4o"> undefined
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">visibilityDirty</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="13"><span class="sTEyZ">            visibilityDirty</span><span class="sMK4o"> =</span><span class="sfNiH"> false
</span></span><span class="line" line="14"><span class="sMK4o">            this.</span><span class="s2Zo4">updateQueuesAndCulling</span><span class="swJcz">()
</span></span><span class="line" line="15"><span class="sMK4o">        }
</span></span><span class="line" line="16"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">docsDirty</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="17"><span class="sTEyZ">            docsDirty</span><span class="sMK4o"> =</span><span class="sfNiH"> false
</span></span><span class="line" line="18"><span class="sMK4o">            this.</span><span class="s2Zo4">updateTree</span><span class="swJcz">()
</span></span><span class="line" line="19"><span class="sMK4o">            this.</span><span class="s2Zo4">initBackgroundQueue</span><span class="swJcz">()
</span></span><span class="line" line="20"><span class="sMK4o">            this.</span><span class="s2Zo4">scheduleTextGeneration</span><span class="swJcz">()
</span></span><span class="line" line="21"><span class="sMK4o">        }
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">canGenerateText</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="24"><span class="spNyl">            const</span><span class="sTEyZ"> now</span><span class="sMK4o"> =</span><span class="sTEyZ"> performance</span><span class="sMK4o">.</span><span class="s2Zo4">now</span><span class="swJcz">()
</span></span><span class="line" line="25"><span class="sHwdD">            // budget is a little lower than the real 16ms just in case
</span></span><span class="line" line="26"><span class="spNyl">            const</span><span class="sTEyZ"> budget</span><span class="sMK4o"> =</span><span class="sbssI"> 13</span><span class="sMK4o"> -</span><span class="swJcz"> (</span><span class="sTEyZ">now</span><span class="sMK4o"> -</span><span class="sTEyZ"> start</span><span class="sMK4o">!</span><span class="swJcz">)
</span></span><span class="line" line="27"><span class="sMK4o">            this.</span><span class="s2Zo4">generateCardText</span><span class="swJcz">(</span><span class="sMK4o">this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">,</span><span class="sMK4o"> &quot;</span><span class="sfazB">visible</span><span class="sMK4o">&quot;</span><span class="sMK4o">,</span><span class="sMK4o"> {</span><span class="swJcz"> startTime</span><span class="sMK4o">:</span><span class="sTEyZ"> now</span><span class="sMK4o">,</span><span class="sTEyZ"> budget</span><span class="sMK4o"> }</span><span class="swJcz">)
</span></span><span class="line" line="28"><span class="sMK4o">        }
</span></span><span class="line" line="29"><span class="sMK4o">    }</span><span class="swJcz">)
</span></span><span class="line" line="30"><span class="sMK4o">}
</span></span><span class="line" line="31"><span emptylineplaceholder="true">
</span></span><span class="line" line="32"><span emptylineplaceholder="true">
</span></span><span class="line" line="33"><span class="sHwdD">// we combine these actions because they both happen together and need to both iterate through the same data
</span></span><span class="line" line="34"><span class="s2Zo4">updateQueuesAndCulling</span><span class="sTEyZ">() </span><span class="sMK4o">{
</span></span><span class="line" line="35"><span class="spNyl">    const</span><span class="sMK4o"> {</span><span class="sTEyZ"> visibleNotes</span><span class="sMK4o">,</span><span class="sTEyZ"> visibleAreas</span><span class="sMK4o"> }</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="sTEyZ">visible</span><span class="sMK4o">.</span><span class="sTEyZ">value
</span></span><span class="line" line="36"><span emptylineplaceholder="true">
</span></span><span class="line" line="37"><span class="sMK4o">    this.</span><span class="s2Zo4">updateVisibleAreas</span><span class="swJcz">(</span><span class="sTEyZ">visibleAreas</span><span class="swJcz">)
</span></span><span class="line" line="38"><span emptylineplaceholder="true">
</span></span><span class="line" line="39"><span class="spNyl">    const</span><span class="sTEyZ"> showFullText</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="sTEyZ">lodState</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">full</span><span class="sMK4o">&quot;
</span></span><span class="line" line="40"><span class="spNyl">    const</span><span class="sTEyZ"> cardLodVisible</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="sTEyZ">lodState</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o"> !==</span><span class="sMK4o"> &quot;</span><span class="sfazB">noCards</span><span class="sMK4o">&quot;
</span></span><span class="line" line="41"><span emptylineplaceholder="true">
</span></span><span class="line" line="42"><span class="s7zQu">    for</span><span class="swJcz"> (</span><span class="spNyl">const</span><span class="sMK4o"> [</span><span class="sTEyZ">path</span><span class="sMK4o">,</span><span class="sTEyZ"> card</span><span class="sMK4o">]</span><span class="sMK4o"> of</span><span class="sMK4o"> this.</span><span class="sTEyZ">noteSprites</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="43"><span class="spNyl">        const</span><span class="sTEyZ"> isVisible</span><span class="sMK4o"> =</span><span class="sTEyZ"> visibleNotes</span><span class="sMK4o">.</span><span class="s2Zo4">has</span><span class="swJcz">(</span><span class="sTEyZ">path</span><span class="swJcz">)
</span></span><span class="line" line="44"><span class="spNyl">        const</span><span class="sTEyZ"> titleText</span><span class="sMK4o"> =</span><span class="sTEyZ"> card</span><span class="sMK4o">.</span><span class="s2Zo4">getChildByLabel</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">title-text</span><span class="sMK4o">&quot;</span><span class="swJcz">) </span><span class="s7zQu">as</span><span class="sBMFI"> Text
</span></span><span class="line" line="45"><span class="spNyl">        const</span><span class="sTEyZ"> textAlreadyGenerated</span><span class="sMK4o"> =</span><span class="sTEyZ"> titleText</span><span class="sMK4o">.</span><span class="sTEyZ">text</span><span class="sMK4o"> !==</span><span class="sMK4o"> &quot;&quot;
</span></span><span class="line" line="46"><span emptylineplaceholder="true">
</span></span><span class="line" line="47"><span class="sTEyZ">        card</span><span class="sMK4o">.</span><span class="sTEyZ">visible</span><span class="sMK4o"> =</span><span class="sTEyZ"> isVisible</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> cardLodVisible
</span></span><span class="line" line="48"><span emptylineplaceholder="true">
</span></span><span class="line" line="49"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sMK4o">!</span><span class="sTEyZ">textAlreadyGenerated</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="50"><span class="s7zQu">            if</span><span class="swJcz"> (</span><span class="sTEyZ">isVisible</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> showFullText</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="51"><span class="sMK4o">                this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="52"><span class="sMK4o">                this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">add</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="53"><span class="sMK4o">            }</span><span class="s7zQu"> else</span><span class="sMK4o"> {
</span></span><span class="line" line="54"><span class="sMK4o">                this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="55"><span class="sMK4o">                this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">add</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="56"><span class="sMK4o">            }
</span></span><span class="line" line="57"><span class="sMK4o">        }</span><span class="s7zQu"> else</span><span class="sMK4o"> {
</span></span><span class="line" line="58"><span class="sMK4o">            this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="59"><span class="sMK4o">            this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="60"><span class="sMK4o">        }
</span></span><span class="line" line="61"><span class="sMK4o">    }
</span></span><span class="line" line="62"><span emptylineplaceholder="true">
</span></span><span class="line" line="63"><span class="spNyl">    const</span><span class="sTEyZ"> cards</span><span class="sMK4o"> =</span><span class="sTEyZ"> visibleNotes</span><span class="sMK4o">.</span><span class="s2Zo4">keys</span><span class="swJcz">()
</span></span><span class="line" line="64"><span class="sMK4o">        .</span><span class="s2Zo4">map</span><span class="swJcz">(</span><span class="sHdIc">path</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> this.</span><span class="sTEyZ">noteSprites</span><span class="sMK4o">.</span><span class="s2Zo4">get</span><span class="swJcz">(</span><span class="sTEyZ">path</span><span class="swJcz">)</span><span class="sMK4o">!</span><span class="swJcz">)</span><span class="sMK4o">.</span><span class="s2Zo4">filter</span><span class="swJcz">(</span><span class="sHdIc">_</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> !!</span><span class="sTEyZ">_</span><span class="swJcz">)
</span></span><span class="line" line="65"><span class="sMK4o">    this.</span><span class="s2Zo4">updateCardsLodState</span><span class="swJcz">(</span><span class="sTEyZ">cards</span><span class="swJcz">)
</span></span><span class="line" line="66"><span class="sMK4o">}
</span></span><span class="line" line="67"><span emptylineplaceholder="true">
</span></span><span class="line" line="68"><span emptylineplaceholder="true">
</span></span><span class="line" line="69"><span class="sHwdD">// initially, queue up all cards that don&#39;t have text yet
</span></span><span class="line" line="70"><span class="s2Zo4">initBackgroundQueue</span><span class="sTEyZ">() </span><span class="sMK4o">{
</span></span><span class="line" line="71"><span class="s7zQu">    for</span><span class="swJcz"> (</span><span class="spNyl">const</span><span class="sTEyZ"> card</span><span class="sMK4o"> of</span><span class="sTEyZ"> allNoteSprites</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="72"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">card</span><span class="sMK4o">.</span><span class="sTEyZ">text</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;&quot;</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="73"><span class="sTEyZ">            backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">add</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)</span><span class="sMK4o">;
</span></span><span class="line" line="74"><span class="sMK4o">        }
</span></span><span class="line" line="75"><span class="sMK4o">    }
</span></span><span class="line" line="76"><span class="sMK4o">}
</span></span><span class="line" line="77"><span emptylineplaceholder="true">
</span></span><span class="line" line="78"><span class="sHwdD">// create the function that actually schedules the work
</span></span><span class="line" line="79"><span class="s2Zo4">scheduleTextGeneration</span><span class="sTEyZ">() </span><span class="sMK4o">{
</span></span><span class="line" line="80"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sMK4o">this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="sTEyZ">size</span><span class="sMK4o"> &gt;</span><span class="sbssI"> 0</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> this.</span><span class="sTEyZ">idleCallbackId</span><span class="sMK4o"> ===</span><span class="sMK4o"> null</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="81"><span class="sMK4o">        this.</span><span class="sTEyZ">idleCallbackId</span><span class="sMK4o"> =</span><span class="s2Zo4"> requestIdleCallback</span><span class="swJcz">(</span><span class="sMK4o">(</span><span class="sHdIc">deadline</span><span class="sMK4o">)</span><span class="spNyl"> =&gt;</span><span class="sMK4o"> {
</span></span><span class="line" line="82"><span class="sMK4o">            this.</span><span class="sTEyZ">idleCallbackId</span><span class="sMK4o"> =</span><span class="sMK4o"> null
</span></span><span class="line" line="83"><span class="sMK4o">            this.</span><span class="s2Zo4">generateCardText</span><span class="swJcz">(</span><span class="sMK4o">this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">,</span><span class="sMK4o"> &quot;</span><span class="sfazB">background</span><span class="sMK4o">&quot;</span><span class="sMK4o">,</span><span class="sMK4o"> {</span><span class="sTEyZ"> deadline</span><span class="sMK4o"> }</span><span class="swJcz">)
</span></span><span class="line" line="84"><span class="sMK4o">            this.</span><span class="s2Zo4">scheduleTextGeneration</span><span class="swJcz">()
</span></span><span class="line" line="85"><span class="sMK4o">        }</span><span class="swJcz">)
</span></span><span class="line" line="86"><span class="sMK4o">    }</span><span class="s7zQu"> else</span><span class="s7zQu"> if</span><span class="swJcz"> (</span><span class="sMK4o">this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="sTEyZ">size</span><span class="sMK4o"> ===</span><span class="sbssI"> 0</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="87"><span class="sHwdD">        // generation finished
</span></span><span class="line" line="88"><span class="sMK4o">    }
</span></span><span class="line" line="89"><span class="sMK4o">}
</span></span><span class="line" line="90"><span emptylineplaceholder="true">
</span></span><span class="line" line="91"><span class="sHwdD">/** Generate text for cards from a pending queue with a deadline or a time budget. */
</span></span><span class="line" line="92"><span class="s2Zo4">generateCardText</span><span class="sTEyZ">(
</span></span><span class="line" line="93"><span class="sTEyZ">    pending: Set</span><span class="sMK4o">&lt;</span><span class="sTEyZ">Container</span><span class="sMK4o">&gt;,
</span></span><span class="line" line="94"><span class="sTEyZ">    type: </span><span class="sMK4o">&quot;</span><span class="sfazB">visible</span><span class="sMK4o">&quot;</span><span class="sMK4o"> |</span><span class="sMK4o"> &quot;</span><span class="sfazB">background</span><span class="sMK4o">&quot;</span><span class="sMK4o">,
</span></span><span class="line" line="95"><span class="sMK4o">    {
</span></span><span class="line" line="96"><span class="sTEyZ">        deadline</span><span class="sMK4o">,
</span></span><span class="line" line="97"><span class="sTEyZ">        budget</span><span class="sMK4o">,
</span></span><span class="line" line="98"><span class="sTEyZ">        startTime
</span></span><span class="line" line="99"><span class="sMK4o">    }</span><span class="sTEyZ">: </span><span class="sMK4o">{
</span></span><span class="line" line="100"><span class="sTEyZ">        deadline?</span><span class="sMK4o">:</span><span class="sTEyZ"> IdleDeadline
</span></span><span class="line" line="101"><span class="sTEyZ">        startTime</span><span class="sMK4o">?:</span><span class="sTEyZ"> number
</span></span><span class="line" line="102"><span class="sTEyZ">        budget</span><span class="sMK4o">?:</span><span class="sTEyZ"> number
</span></span><span class="line" line="103"><span class="sMK4o">    }</span><span class="sMK4o"> =</span><span class="sMK4o"> {}
</span></span><span class="line" line="104"><span class="sTEyZ">) </span><span class="sMK4o">{
</span></span><span class="line" line="105"><span class="swJcz">    
</span></span><span class="line" line="106"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">pending</span><span class="sMK4o">.</span><span class="sTEyZ">size</span><span class="sMK4o"> ===</span><span class="sbssI"> 0</span><span class="swJcz">) </span><span class="s7zQu">return
</span></span><span class="line" line="107"><span emptylineplaceholder="true">
</span></span><span class="line" line="108"><span class="sHwdD">    // the 1 is the aproximate time the truncation takes
</span></span><span class="line" line="109"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">budget</span><span class="sMK4o"> !==</span><span class="sMK4o"> undefined</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> budget</span><span class="sMK4o"> &lt;=</span><span class="sbssI"> 1</span><span class="swJcz">) </span><span class="s7zQu">return
</span></span><span class="line" line="110"><span emptylineplaceholder="true">
</span></span><span class="line" line="111"><span class="spNyl">    const</span><span class="sTEyZ"> isVisible</span><span class="sMK4o"> =</span><span class="sTEyZ"> type</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">visible</span><span class="sMK4o">&quot;
</span></span><span class="line" line="112"><span emptylineplaceholder="true">
</span></span><span class="line" line="113"><span class="spNyl">    const</span><span class="sTEyZ"> iterator</span><span class="sMK4o"> =</span><span class="sTEyZ"> pending</span><span class="sMK4o">.</span><span class="s2Zo4">values</span><span class="swJcz">()
</span></span><span class="line" line="114"><span class="spNyl">    let</span><span class="sTEyZ"> generated</span><span class="sMK4o"> =</span><span class="sbssI"> 0
</span></span><span class="line" line="115"><span emptylineplaceholder="true">
</span></span><span class="line" line="116"><span class="s7zQu">    while</span><span class="swJcz"> (</span><span class="sTEyZ">pending</span><span class="sMK4o">.</span><span class="sTEyZ">size</span><span class="sMK4o"> &gt;</span><span class="sbssI"> 0</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="117"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">budget</span><span class="sMK4o"> !==</span><span class="sMK4o"> undefined</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> isVisible</span><span class="sMK4o"> &amp;&amp;</span><span class="swJcz"> (</span><span class="sTEyZ">performance</span><span class="sMK4o">.</span><span class="s2Zo4">now</span><span class="swJcz">() </span><span class="sMK4o">-</span><span class="sTEyZ"> startTime</span><span class="sMK4o">!</span><span class="swJcz">) </span><span class="sMK4o">&gt;=</span><span class="sTEyZ"> budget</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="118"><span class="s7zQu">            break
</span></span><span class="line" line="119"><span class="sMK4o">        }
</span></span><span class="line" line="120"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">deadline</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> deadline</span><span class="sMK4o">.</span><span class="s2Zo4">timeRemaining</span><span class="swJcz">() </span><span class="sMK4o">&lt;=</span><span class="sbssI"> 1</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="121"><span class="s7zQu">            break
</span></span><span class="line" line="122"><span class="sMK4o">        }
</span></span><span class="line" line="123"><span class="spNyl">        const</span><span class="sTEyZ"> next</span><span class="sMK4o"> =</span><span class="sTEyZ"> iterator</span><span class="sMK4o">.</span><span class="s2Zo4">next</span><span class="swJcz">()
</span></span><span class="line" line="124"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">next</span><span class="sMK4o">.</span><span class="sTEyZ">done</span><span class="swJcz">) </span><span class="s7zQu">break
</span></span><span class="line" line="125"><span emptylineplaceholder="true">
</span></span><span class="line" line="126"><span class="spNyl">        const</span><span class="sTEyZ"> card</span><span class="sMK4o"> =</span><span class="sTEyZ"> next</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="s7zQu"> as</span><span class="sBMFI"> Container
</span></span><span class="line" line="127"><span emptylineplaceholder="true">
</span></span><span class="line" line="128"><span class="sTEyZ">        pending</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="129"><span emptylineplaceholder="true">
</span></span><span class="line" line="130"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">type</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">visible</span><span class="sMK4o">&quot;</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="131"><span class="sMK4o">            this.</span><span class="sTEyZ">backgroundPendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">delete</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)
</span></span><span class="line" line="132"><span class="sHwdD">            // skip if card became invisible or LOD changed
</span></span><span class="line" line="133"><span class="s7zQu">            if</span><span class="swJcz"> (</span><span class="sMK4o">!</span><span class="sTEyZ">card</span><span class="sMK4o">.</span><span class="sTEyZ">visible</span><span class="sMK4o"> ||</span><span class="sMK4o"> this.</span><span class="sTEyZ">lodState</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o"> !==</span><span class="sMK4o"> &quot;</span><span class="sfazB">full</span><span class="sMK4o">&quot;</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="134"><span class="s7zQu">                continue
</span></span><span class="line" line="135"><span class="sMK4o">            }
</span></span><span class="line" line="136"><span class="sMK4o">        }</span><span class="s7zQu"> else</span><span class="s7zQu"> if</span><span class="swJcz"> (</span><span class="sTEyZ">type</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">background</span><span class="sMK4o">&quot;</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> this.</span><span class="sTEyZ">pendingTextGeneration</span><span class="sMK4o">.</span><span class="s2Zo4">has</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="swJcz">)) </span><span class="sMK4o">{
</span></span><span class="line" line="137"><span class="s7zQu">            continue
</span></span><span class="line" line="138"><span class="sMK4o">        }
</span></span><span class="line" line="139"><span emptylineplaceholder="true">
</span></span><span class="line" line="140"><span class="spNyl">        const</span><span class="sTEyZ"> titleText</span><span class="sMK4o"> =</span><span class="sTEyZ"> card</span><span class="sMK4o">.</span><span class="s2Zo4">getChildByLabel</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">title-text</span><span class="sMK4o">&quot;</span><span class="swJcz">) </span><span class="s7zQu">as</span><span class="sBMFI"> Text
</span></span><span class="line" line="141"><span class="sHwdD">        // const summaryText = ...
</span></span><span class="line" line="142"><span class="spNyl">        const</span><span class="sTEyZ"> doc</span><span class="sMK4o"> =</span><span class="sMK4o"> this.</span><span class="s2Zo4">getDoc</span><span class="swJcz">(</span><span class="sTEyZ">card</span><span class="sMK4o">.</span><span class="sTEyZ">label</span><span class="swJcz">)
</span></span><span class="line" line="143"><span class="sHwdD">        // doc might have been deleted by the time we get here
</span></span><span class="line" line="144"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sMK4o">!</span><span class="sTEyZ">doc</span><span class="swJcz">) </span><span class="s7zQu">continue
</span></span><span class="line" line="145"><span emptylineplaceholder="true">
</span></span><span class="line" line="146"><span class="sTEyZ">        generated</span><span class="sMK4o">++
</span></span><span class="line" line="147"><span emptylineplaceholder="true">
</span></span><span class="line" line="148"><span class="sTEyZ">        titleText</span><span class="sMK4o">.</span><span class="sTEyZ">text</span><span class="sMK4o"> =</span><span class="sTEyZ"> PixiCanvas</span><span class="sMK4o">.</span><span class="s2Zo4">truncatePixiText</span><span class="swJcz">( </span><span class="sTEyZ">doc</span><span class="sMK4o">.</span><span class="sTEyZ">title</span><span class="sMK4o">,</span><span class="sHwdD"> /* ... */</span><span class="swJcz">)
</span></span><span class="line" line="149"><span class="sHwdD">        // summaryText.text = PixiCanvas.truncatePixiText( ... )
</span></span><span class="line" line="150"><span emptylineplaceholder="true">
</span></span><span class="line" line="151"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">card</span><span class="sMK4o">.</span><span class="sTEyZ">visible</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> this.</span><span class="sTEyZ">lodState</span><span class="sMK4o">.</span><span class="sTEyZ">value</span><span class="sMK4o"> ===</span><span class="sMK4o"> &quot;</span><span class="sfazB">full</span><span class="sMK4o">&quot;</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="152"><span class="sHwdD">            // set visibility of elements
</span></span><span class="line" line="153"><span class="sMK4o">        }
</span></span><span class="line" line="154"><span class="sMK4o">    }
</span></span><span class="line" line="155"><span class="sMK4o">}
</span></span></code><!--]--></pre></div><!--]--></details><h3 id="faster-text-truncation" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#faster-text-truncation" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Faster Text Truncation<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->Initially I just looked up how to do text truncation and found this snippet on the <!--[--><a href="https://github.com/pixijs/pixijs/issues/3449#issuecomment-428648004" rel="nofollow" class="text-primary border-b border-transparent hover:border-primary font-medium focus-visible:outline-primary focus-visible:has-[&gt;code]:outline-0 [&amp;&gt;code]:border-dashed hover:[&amp;&gt;code]:border-primary hover:[&amp;&gt;code]:text-primary focus-visible:[&amp;&gt;code]:border-primary focus-visible:[&amp;&gt;code]:text-primary transition-colors [&amp;&gt;code]:transition-colors"><!--[--><!--[--><!--[-->repo<!--]--><!--]--><!--]--></a><!--]--> which you&#39;ll probably come across if searching for how to do this. Hereâ€™s the modified version I initially used:<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="sHwdD">/** Truncates text to a specific number of lines using PixiJS TextMetrics */
</span></span><span class="line" line="2"><span class="sTEyZ">static </span><span class="s2Zo4">truncatePixiText</span><span class="sTEyZ">(
</span></span><span class="line" line="3"><span class="sHwdD">    /** The raw string to truncate */
</span></span><span class="line" line="4"><span class="sTEyZ">    text: string</span><span class="sMK4o">,
</span></span><span class="line" line="5"><span class="sHwdD">    /** PixiJS TextStyle object or configuration */
</span></span><span class="line" line="6"><span class="sTEyZ">    style: TextStyle</span><span class="sMK4o">,
</span></span><span class="line" line="7"><span class="sHwdD">    /** Maximum number of lines allowed before truncation */
</span></span><span class="line" line="8"><span class="sTEyZ">    maxLines: number
</span></span><span class="line" line="9"><span class="sTEyZ">): string </span><span class="sMK4o">{
</span></span><span class="line" line="10"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">maxLines</span><span class="sMK4o"> ===</span><span class="sMK4o"> Infinity</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="11"><span class="s7zQu">        return</span><span class="sTEyZ"> text
</span></span><span class="line" line="12"><span class="sMK4o">    }
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span class="spNyl">    const</span><span class="sTEyZ"> wordWrapWidth</span><span class="sMK4o"> =</span><span class="sTEyZ"> style</span><span class="sMK4o">.</span><span class="sTEyZ">wordWrapWidth
</span></span><span class="line" line="15"><span class="spNyl">    const</span><span class="sMK4o"> {</span><span class="sTEyZ"> lines</span><span class="sMK4o"> }</span><span class="sMK4o"> =</span><span class="sTEyZ"> CanvasTextMetrics</span><span class="sMK4o">.</span><span class="s2Zo4">measureText</span><span class="swJcz">(</span><span class="sTEyZ">text</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="swJcz">)
</span></span><span class="line" line="16"><span emptylineplaceholder="true">
</span></span><span class="line" line="17"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> &lt;=</span><span class="sTEyZ"> maxLines</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="18"><span class="s7zQu">        return</span><span class="sTEyZ"> text
</span></span><span class="line" line="19"><span class="sMK4o">    }
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span class="spNyl">    const</span><span class="sTEyZ"> truncatedLines</span><span class="sMK4o"> =</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="s2Zo4">slice</span><span class="swJcz">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sTEyZ"> maxLines</span><span class="swJcz">)
</span></span><span class="line" line="22"><span class="spNyl">    const</span><span class="sTEyZ"> lastLine</span><span class="sMK4o"> =</span><span class="sTEyZ"> truncatedLines</span><span class="swJcz">[</span><span class="sTEyZ">truncatedLines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">]
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span class="spNyl">    const</span><span class="sTEyZ"> chars</span><span class="sMK4o"> =</span><span class="sTEyZ"> Array</span><span class="sMK4o">.</span><span class="s2Zo4">from</span><span class="swJcz">(</span><span class="sTEyZ">lastLine</span><span class="swJcz">)
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span class="sHwdD">    // measure the ellipsis and each character individually
</span></span><span class="line" line="27"><span class="spNyl">    const</span><span class="sTEyZ"> charMetrics</span><span class="sMK4o"> =</span><span class="sTEyZ"> CanvasTextMetrics</span><span class="sMK4o">.</span><span class="s2Zo4">measureText</span><span class="swJcz">(</span><span class="sMK4o">`</span><span class="sfazB">...</span><span class="sTEyZ">\n</span><span class="sMK4o">${</span><span class="sTEyZ">chars</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="sTEyZ">(</span><span class="sMK4o">&quot;</span><span class="sTEyZ">\n</span><span class="sMK4o">&quot;</span><span class="sTEyZ">)</span><span class="sMK4o">}`</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="swJcz">)
</span></span><span class="line" line="28"><span class="spNyl">    const</span><span class="sMK4o"> [</span><span class="sTEyZ">dotsLength</span><span class="sMK4o">,</span><span class="sMK4o"> ...</span><span class="sTEyZ">charLengths</span><span class="sMK4o">]</span><span class="sMK4o"> =</span><span class="sTEyZ"> charMetrics</span><span class="sMK4o">.</span><span class="sTEyZ">lineWidths
</span></span><span class="line" line="29"><span emptylineplaceholder="true">
</span></span><span class="line" line="30"><span class="spNyl">    let</span><span class="sTEyZ"> newLastLine</span><span class="sMK4o"> =</span><span class="sMK4o"> &quot;&quot;</span><span class="sMK4o">;
</span></span><span class="line" line="31"><span class="spNyl">    let</span><span class="sTEyZ"> currentLength</span><span class="sMK4o"> =</span><span class="sTEyZ"> dotsLength</span><span class="sMK4o">;
</span></span><span class="line" line="32"><span emptylineplaceholder="true">
</span></span><span class="line" line="33"><span class="s7zQu">    for</span><span class="swJcz"> (</span><span class="spNyl">let</span><span class="sTEyZ"> i</span><span class="sMK4o"> =</span><span class="sbssI"> 0</span><span class="sMK4o">;</span><span class="sTEyZ"> i</span><span class="sMK4o"> &lt;</span><span class="sTEyZ"> charLengths</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o">;</span><span class="sTEyZ"> i</span><span class="sMK4o">++</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="34"><span class="spNyl">        const</span><span class="sTEyZ"> charLength</span><span class="sMK4o"> =</span><span class="sTEyZ"> charLengths</span><span class="swJcz">[</span><span class="sTEyZ">i</span><span class="swJcz">]</span><span class="sMK4o">;
</span></span><span class="line" line="35"><span emptylineplaceholder="true">
</span></span><span class="line" line="36"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">currentLength</span><span class="sMK4o"> +</span><span class="sTEyZ"> charLength</span><span class="sMK4o"> &gt;=</span><span class="sTEyZ"> wordWrapWidth</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="37"><span class="s7zQu">            break</span><span class="sMK4o">;</span><span class="swJcz"> 
</span></span><span class="line" line="38"><span class="sMK4o">        }
</span></span><span class="line" line="39"><span emptylineplaceholder="true">
</span></span><span class="line" line="40"><span class="sTEyZ">        newLastLine</span><span class="sMK4o"> +=</span><span class="sTEyZ"> chars</span><span class="swJcz">[</span><span class="sTEyZ">i</span><span class="swJcz">]</span><span class="sMK4o">;
</span></span><span class="line" line="41"><span class="sTEyZ">        currentLength</span><span class="sMK4o"> +=</span><span class="sTEyZ"> charLength</span><span class="sMK4o">;
</span></span><span class="line" line="42"><span class="sMK4o">    }
</span></span><span class="line" line="43"><span emptylineplaceholder="true">
</span></span><span class="line" line="44"><span class="sTEyZ">    truncatedLines</span><span class="swJcz">[</span><span class="sTEyZ">truncatedLines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">=</span><span class="sMK4o"> `${</span><span class="sTEyZ">newLastLine</span><span class="sMK4o">}</span><span class="sfazB">...</span><span class="sMK4o">`
</span></span><span class="line" line="45"><span class="s7zQu">    return</span><span class="sTEyZ"> truncatedLines</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sTEyZ">\n</span><span class="sMK4o">&quot;</span><span class="swJcz">)
</span></span><span class="line" line="46"><span class="sMK4o">}
</span></span></code><!--]--></pre></div><!--]--></details><p class="my-5 leading-7 text-pretty"><!--[-->As you can see this text truncation function requires two measurements. First, based on the text style, it measures how many lines the wrapped text produces. Then, it takes the line and measure character by character to see where to cut it (the original measured by word, I wanted by character, both are slow).<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Pixi does tons of caching internally, but it&#39;s just a slow thing to calculate. It&#39;s also specially slow with regular <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->Text<!--]--></code> (which I was using at the beginning).<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->So how to speed this up (apart from using <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->BitmapText<!--]--></code>)? See if you can spot it before reading on. The biggest performance gain feels a bit obvious once you see it.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Some low hanging fruit first, if you have long note summaries that aren&#39;t already truncated, it&#39;s measuring all that text which won&#39;t be visible.<!--]--></p><h4 id="optimization-1-limiting-text-length" class="text-lg text-highlighted font-bold mt-6 mb-2 scroll-mt-[calc(24px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(24px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary"><a href="#optimization-1-limiting-text-length" class=""><!--[-->Optimization 1 - Limiting Text Length<!--]--></a></h4><p class="my-5 leading-7 text-pretty"><!--[-->I measured the smallest character (usually a space) and calculated how many we could fit in a card.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->We can then use this to limit how much text we even try to truncate. This should also done as soon as we can after we receive the data to avoid keeping the full summary in memory.<!--]--></p><h4 id="optimization-2-avoiding-the-second-measurement" class="text-lg text-highlighted font-bold mt-6 mb-2 scroll-mt-[calc(24px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(24px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary"><a href="#optimization-2-avoiding-the-second-measurement" class=""><!--[-->Optimization 2 - Avoiding the Second Measurement<!--]--></a></h4><p class="my-5 leading-7 text-pretty"><!--[-->We want to avoid the second measurement of the characters at all costs.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I tried caching the measurements of individual characters to calculate the aproximate width of the last line myself. Pixi is already technically doing this but it doesn&#39;t keep the cache around between calls. That was faster, but still slow.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I considered using a monospace font even though I didn&#39;t like the idea of being restricted to monospace fonts.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->I asked the LLMs. They added a third measurement call just to rage bait me, and I went back to thinking.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->And then I saw it.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->When pixi does the first measurement, it also chops up the line, and we know what text is on which line and how long it is already! ðŸ¤¦<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Now, <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->.<!--]--></code> is usually the shortest character in a font (and if not, we should pick a font where it is).<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->So when a line needs an ellipsis <strong><!--[-->all<!--]--></strong> the last characters we need to chop off are wider than a period. When we replace them, the line is always guaranteed to be shorter.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->For example, say we want max 2 lines:<!--]--></p><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="sTEyZ">         cutoff â”€â”
</span></span><span class="line" line="2"><span class="sTEyZ">                 ðŸ­­ 
</span></span><span class="line" line="3"><span class="sTEyZ">Some long text we want to truncate
</span></span><span class="line" line="4"><span class="sTEyZ">            
</span></span><span class="line" line="5"><span class="sHwdD">// pixi will wrap it to:
</span></span><span class="line" line="6"><span class="sTEyZ">                 ðŸ­­ 
</span></span><span class="line" line="7"><span class="sTEyZ">Some long text
</span></span><span class="line" line="8"><span class="sTEyZ">we want to truncate
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span class="sHwdD">// and we want:
</span></span><span class="line" line="11"><span class="sTEyZ">                 ðŸ­­ 
</span></span><span class="line" line="12"><span class="sTEyZ">Some long text
</span></span><span class="line" line="13"><span class="sTEyZ">we want to trun</span><span class="sMK4o">...
</span></span></code><!--]--></pre></div><p class="my-5 leading-7 text-pretty"><!--[-->With a non-monospace font, here&#39;s how they compare:<!--]--></p><blockquote class="border-s-4 border-accented ps-4 italic"><!--[--><p class="my-5 leading-7 text-pretty"><!--[-->we want to truncate<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->we want to trun...<!--]--></p><!--]--></blockquote><p class="my-5 leading-7 text-pretty"><!--[-->The truncated line is always shorter.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->If we want truncation at the word level, we can just find the first space that&#39;s at least 3 characters in.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->Here&#39;s the final code which takes about 20% less time.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->This version supports both Text and BitmapText. As mentioned above bitmap support is crucial as otherwise regular text is still too slow even with this speedup.<!--]--></p><details class="md-details rounded-lg bg-primary-500/10 p-2"><summary class="border rounded-md border-primary-500/30 bg-primary-500/20 p-3 focus:outline-none focus:border-primary-500 text-center"><!--[-->Click to Show<!--]--></summary><!--[--><div class="relative my-5 group" style=""><!----><!--[--><!--[--><button type="button" aria-label="Copy code to clipboard" tabindex="-1" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 text-xs gap-1.5 ring ring-inset ring-accented text-default bg-default hover:bg-elevated active:bg-elevated disabled:bg-default aria-disabled:bg-default focus:outline-none focus-visible:ring-2 focus-visible:ring-inverted p-1.5 absolute top-[11px] right-[11px] lg:opacity-0 lg:group-hover:opacity-100 transition"><!--[--><!--[--><span class="iconify i-lucide:copy shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--><pre class="group font-mono text-sm/6 border border-muted bg-muted rounded-md px-4 py-3 whitespace-pre-wrap break-words overflow-x-auto focus:outline-none language-ts shiki shiki-themes material-theme-lighter material-theme material-theme-palenight" style=""><!--[--><code><span class="line" line="1"><span class="sHwdD">/**
</span></span><span class="line" line="2"><span class="sHwdD">* Truncates text to a specific number of lines using PixiJS TextMetrics.
</span></span><span class="line" line="3"><span class="sHwdD">*
</span></span><span class="line" line="4"><span class="sHwdD">* Uses lots of optimizations and caching to make this as fast as possible.
</span></span><span class="line" line="5"><span class="sHwdD">*
</span></span><span class="line" line="6"><span class="sHwdD">* IMPORTANT: Be sure to pre-slice the text if it can get very long.
</span></span><span class="line" line="7"><span class="sHwdD">*/
</span></span><span class="line" line="8"><span class="sTEyZ">static </span><span class="s2Zo4">truncatePixiText</span><span class="sTEyZ">(
</span></span><span class="line" line="9"><span class="sHwdD">    /** The raw string to truncate */
</span></span><span class="line" line="10"><span class="sTEyZ">    text: string</span><span class="sMK4o">,
</span></span><span class="line" line="11"><span class="sHwdD">    /** PixiJS TextStyle object or configuration */
</span></span><span class="line" line="12"><span class="sTEyZ">    style: TextStyle</span><span class="sMK4o">,
</span></span><span class="line" line="13"><span class="sHwdD">    /** Whether to use the bitmap text measuring method or the canvas text measuring method. Words will NOT wrap right if you use the wrong one. */
</span></span><span class="line" line="14"><span class="sTEyZ">    isBitmapFont: boolean </span><span class="sMK4o">=</span><span class="sfNiH"> true</span><span class="sMK4o">,
</span></span><span class="line" line="15"><span class="sHwdD">    /** Maximum number of lines allowed before truncation */
</span></span><span class="line" line="16"><span class="sTEyZ">    maxLines: number</span><span class="sMK4o">,
</span></span><span class="line" line="17"><span class="sHwdD">    /** Since we recommend slicing the text, we can&#39;t be sure if there are more lines or not and whether to add an ellipsis to the last line.
</span></span><span class="line" line="18"><span class="sHwdD">    * </span><span class="s7zQu">@</span><span class="s6hCs">default</span><span class="sHdIc"> false
</span></span><span class="line" line="19"><span class="sHwdD">    */
</span></span><span class="line" line="20"><span class="sTEyZ">    containsMoreLines: boolean </span><span class="sMK4o">=</span><span class="sfNiH"> false</span><span class="sMK4o">,
</span></span><span class="line" line="21"><span class="sHwdD">    /** Pass a cached width. */
</span></span><span class="line" line="22"><span class="sTEyZ">    ellipsisWidth</span><span class="sMK4o">?:</span><span class="sTEyZ"> number
</span></span><span class="line" line="23"><span class="sTEyZ">): string </span><span class="sMK4o">{
</span></span><span class="line" line="24"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">maxLines</span><span class="sMK4o"> ===</span><span class="sMK4o"> Infinity</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="25"><span class="s7zQu">        return</span><span class="sTEyZ"> text
</span></span><span class="line" line="26"><span class="sMK4o">    }
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span class="spNyl">    const</span><span class="sTEyZ"> wordWrapWidth</span><span class="sMK4o"> =</span><span class="sTEyZ"> style</span><span class="sMK4o">.</span><span class="sTEyZ">wordWrapWidth
</span></span><span class="line" line="29"><span emptylineplaceholder="true">
</span></span><span class="line" line="30"><span class="spNyl">    let</span><span class="sTEyZ"> lineWidths</span><span class="sMK4o"> =</span><span class="swJcz"> []
</span></span><span class="line" line="31"><span class="spNyl">    let</span><span class="sTEyZ"> lines</span><span class="sMK4o"> =</span><span class="swJcz"> []
</span></span><span class="line" line="32"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">isBitmapFont</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="33"><span class="spNyl">        const</span><span class="sTEyZ"> measure</span><span class="sMK4o"> =</span><span class="sTEyZ"> BitmapFontManager</span><span class="sMK4o">.</span><span class="s2Zo4">getLayout</span><span class="swJcz">(</span><span class="sTEyZ">text</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="sMK4o">,</span><span class="sfNiH"> true</span><span class="swJcz">)
</span></span><span class="line" line="34"><span emptylineplaceholder="true">
</span></span><span class="line" line="35"><span class="s7zQu">        for</span><span class="swJcz"> (</span><span class="spNyl">let</span><span class="sTEyZ"> i</span><span class="sMK4o"> =</span><span class="sbssI"> 0</span><span class="sMK4o">;</span><span class="sTEyZ"> i</span><span class="sMK4o"> &lt;</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> i</span><span class="sMK4o"> &lt;</span><span class="sTEyZ"> maxLines</span><span class="sMK4o">;</span><span class="sTEyZ"> i</span><span class="sMK4o">++</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="36"><span class="spNyl">                const</span><span class="sTEyZ"> line</span><span class="sMK4o"> =</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">lines</span><span class="swJcz">[</span><span class="sTEyZ">i</span><span class="swJcz">]
</span></span><span class="line" line="37"><span class="spNyl">                const</span><span class="sTEyZ"> chars</span><span class="sMK4o"> =</span><span class="sTEyZ"> line</span><span class="sMK4o">.</span><span class="sTEyZ">chars</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;&quot;</span><span class="swJcz">)
</span></span><span class="line" line="38"><span class="s7zQu">                if</span><span class="swJcz"> (</span><span class="sTEyZ">chars</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> ===</span><span class="sbssI"> 0</span><span class="sMK4o"> &amp;&amp;</span><span class="sTEyZ"> i</span><span class="sMK4o"> ===</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="39"><span class="sHwdD">                    // last line is always empty, idk why
</span></span><span class="line" line="40"><span class="s7zQu">                    break
</span></span><span class="line" line="41"><span class="sMK4o">                }
</span></span><span class="line" line="42"><span class="sTEyZ">                lineWidths</span><span class="sMK4o">.</span><span class="s2Zo4">push</span><span class="swJcz">(</span><span class="sTEyZ">line</span><span class="sMK4o">.</span><span class="sTEyZ">width</span><span class="sMK4o"> *</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">scale</span><span class="swJcz">)
</span></span><span class="line" line="43"><span class="sTEyZ">                lines</span><span class="sMK4o">.</span><span class="s2Zo4">push</span><span class="swJcz">(</span><span class="sTEyZ">line</span><span class="sMK4o">.</span><span class="sTEyZ">chars</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;&quot;</span><span class="swJcz">))
</span></span><span class="line" line="44"><span class="sMK4o">        }
</span></span><span class="line" line="45"><span class="sMK4o">    }</span><span class="s7zQu"> else</span><span class="sMK4o"> {
</span></span><span class="line" line="46"><span class="spNyl">        const</span><span class="sTEyZ"> measure</span><span class="sMK4o"> =</span><span class="sTEyZ"> CanvasTextMetrics</span><span class="sMK4o">.</span><span class="s2Zo4">measureText</span><span class="swJcz">(</span><span class="sTEyZ">text</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="swJcz">)
</span></span><span class="line" line="47"><span class="sTEyZ">        lineWidths</span><span class="sMK4o"> =</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">lineWidths
</span></span><span class="line" line="48"><span class="sTEyZ">        lines</span><span class="sMK4o"> =</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="s2Zo4">slice</span><span class="swJcz">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sTEyZ"> maxLines</span><span class="swJcz">)
</span></span><span class="line" line="49"><span class="sMK4o">    }
</span></span><span class="line" line="50"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> &lt;</span><span class="sTEyZ"> maxLines</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="51"><span class="s7zQu">        return</span><span class="sTEyZ"> text
</span></span><span class="line" line="52"><span class="sMK4o">    }
</span></span><span class="line" line="53"><span class="spNyl">    const</span><span class="sTEyZ"> lastLine</span><span class="sMK4o"> =</span><span class="sTEyZ"> lines</span><span class="swJcz">[</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">]
</span></span><span class="line" line="54"><span emptylineplaceholder="true">
</span></span><span class="line" line="55"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">ellipsisWidth</span><span class="sMK4o"> ===</span><span class="sMK4o"> undefined</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="56"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">isBitmapFont</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="57"><span class="spNyl">                const</span><span class="sTEyZ"> measure</span><span class="sMK4o"> =</span><span class="sTEyZ"> BitmapFontManager</span><span class="sMK4o">.</span><span class="s2Zo4">getLayout</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">...</span><span class="sMK4o">&quot;</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="sMK4o">,</span><span class="sfNiH"> true</span><span class="swJcz">)
</span></span><span class="line" line="58"><span class="sTEyZ">                ellipsisWidth</span><span class="sMK4o"> =</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">width</span><span class="sMK4o"> *</span><span class="sTEyZ"> measure</span><span class="sMK4o">.</span><span class="sTEyZ">scale
</span></span><span class="line" line="59"><span class="sMK4o">        }</span><span class="s7zQu"> else</span><span class="sMK4o"> {
</span></span><span class="line" line="60"><span class="sTEyZ">                ellipsisWidth</span><span class="sMK4o"> =</span><span class="sTEyZ"> CanvasTextMetrics</span><span class="sMK4o">.</span><span class="s2Zo4">measureText</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">...</span><span class="sMK4o">&quot;</span><span class="sMK4o">,</span><span class="sTEyZ"> style</span><span class="swJcz">)</span><span class="sMK4o">.</span><span class="sTEyZ">width
</span></span><span class="line" line="61"><span class="sMK4o">        }
</span></span><span class="line" line="62"><span class="sMK4o">    }
</span></span><span class="line" line="63"><span class="spNyl">    const</span><span class="sTEyZ"> ellipsisDontFit</span><span class="sMK4o"> =</span><span class="sTEyZ"> ellipsisWidth</span><span class="sMK4o"> &gt;</span><span class="sTEyZ"> wordWrapWidth
</span></span><span class="line" line="64"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">ellipsisDontFit</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="65"><span class="sTEyZ">        lines</span><span class="swJcz">[</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">=</span><span class="sMK4o"> &quot;&quot;
</span></span><span class="line" line="66"><span class="s7zQu">        return</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;&quot;</span><span class="swJcz">)
</span></span><span class="line" line="67"><span class="sMK4o">    }
</span></span><span class="line" line="68"><span emptylineplaceholder="true">
</span></span><span class="line" line="69"><span class="sHwdD">    // this is a stylistic choice
</span></span><span class="line" line="70"><span class="spNyl">    const</span><span class="sTEyZ"> shouldAddEllipsis</span><span class="sMK4o"> =</span><span class="swJcz"> (</span><span class="sTEyZ">containsMoreLines</span><span class="sMK4o"> ||</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> &gt;</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="swJcz">) </span><span class="sMK4o">&amp;&amp;</span><span class="sMK4o"> !</span><span class="sTEyZ">lastLine</span><span class="sMK4o">.</span><span class="s2Zo4">endsWith</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sfazB">.</span><span class="sMK4o">&quot;</span><span class="swJcz">)
</span></span><span class="line" line="71"><span emptylineplaceholder="true">
</span></span><span class="line" line="72"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">lineWidths</span><span class="swJcz">[</span><span class="sTEyZ">lineWidths</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">+</span><span class="sTEyZ"> ellipsisWidth</span><span class="sMK4o"> &lt;</span><span class="sTEyZ"> wordWrapWidth</span><span class="sMK4o"> &amp;&amp;</span><span class="sMK4o"> !</span><span class="sTEyZ">shouldAddEllipsis</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="73"><span class="s7zQu">        return</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;&quot;</span><span class="swJcz">)
</span></span><span class="line" line="74"><span class="sMK4o">    }
</span></span><span class="line" line="75"><span emptylineplaceholder="true">
</span></span><span class="line" line="76"><span class="s7zQu">    if</span><span class="swJcz"> (</span><span class="sTEyZ">style</span><span class="sMK4o">.</span><span class="sTEyZ">breakWords</span><span class="swJcz">) </span><span class="sMK4o">{
</span></span><span class="line" line="77"><span class="sHwdD">        // dots happen to be the shortest width character in most fonts
</span></span><span class="line" line="78"><span class="sHwdD">        // so we can just cut off the last 3 characters and add the ellipsis
</span></span><span class="line" line="79"><span class="sTEyZ">        lines</span><span class="swJcz">[</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">=</span><span class="sMK4o"> `${</span><span class="sTEyZ">lastLine</span><span class="sMK4o">.</span><span class="s2Zo4">slice</span><span class="sTEyZ">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sTEyZ"> lastLine</span><span class="sMK4o">.</span><span class="sTEyZ">length </span><span class="sMK4o">-</span><span class="sbssI"> 3</span><span class="sTEyZ">)</span><span class="sMK4o">}</span><span class="sfazB">...</span><span class="sMK4o">`
</span></span><span class="line" line="80"><span class="sMK4o">    }</span><span class="s7zQu"> else</span><span class="sMK4o"> {
</span></span><span class="line" line="81"><span class="sHwdD">        // for words, we just have to find the last space that is at least 3 characters in
</span></span><span class="line" line="82"><span class="spNyl">        const</span><span class="sTEyZ"> lastIndex</span><span class="sMK4o"> =</span><span class="sTEyZ"> lastLine</span><span class="sMK4o">.</span><span class="s2Zo4">lastIndexOf</span><span class="swJcz">(</span><span class="sMK4o">&quot;</span><span class="sMK4o"> &quot;</span><span class="sMK4o">,</span><span class="sTEyZ"> lastLine</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 3</span><span class="swJcz">)
</span></span><span class="line" line="83"><span class="s7zQu">        if</span><span class="swJcz"> (</span><span class="sTEyZ">lastIndex</span><span class="sMK4o"> ===</span><span class="sMK4o"> -</span><span class="sbssI">1</span><span class="swJcz">) </span><span class="sTEyZ">lines</span><span class="swJcz">[</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">=</span><span class="sMK4o"> `</span><span class="sfazB">...</span><span class="sMK4o">`
</span></span><span class="line" line="84"><span class="s7zQu">        else</span><span class="sTEyZ"> lines</span><span class="swJcz">[</span><span class="sTEyZ">lines</span><span class="sMK4o">.</span><span class="sTEyZ">length</span><span class="sMK4o"> -</span><span class="sbssI"> 1</span><span class="swJcz">] </span><span class="sMK4o">=</span><span class="sMK4o"> `${</span><span class="sTEyZ">lastLine</span><span class="sMK4o">.</span><span class="s2Zo4">slice</span><span class="sTEyZ">(</span><span class="sbssI">0</span><span class="sMK4o">,</span><span class="sTEyZ"> lastIndex)</span><span class="sMK4o">}</span><span class="sfazB">...</span><span class="sMK4o">`
</span></span><span class="line" line="85"><span class="sMK4o">    }
</span></span><span class="line" line="86"><span class="s7zQu">    return</span><span class="sTEyZ"> lines</span><span class="sMK4o">.</span><span class="s2Zo4">join</span><span class="swJcz">(</span><span class="sMK4o">&quot;&quot;</span><span class="swJcz">)
</span></span><span class="line" line="87"><span class="sMK4o">}
</span></span></code><!--]--></pre></div><!--]--></details><h2 id="further-potential-optimizations" class="relative text-2xl text-highlighted font-bold mt-12 mb-6 scroll-mt-[calc(48px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(48px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-xl/7 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#further-potential-optimizations" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-1 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Further Potential Optimizations<!--]--></a></h2><h3 id="pooling" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#pooling" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Pooling<!--]--></a></h3><p class="my-5 leading-7 text-pretty"><!--[-->This is probably the next biggest optimization I could make and is something Pixi.js recommends for handling a lot of objects.<!--]--></p><p class="my-5 leading-7 text-pretty"><!--[-->If we cache the text wrapping and truncation, we could re-use the same ~1000-2000 text objects and just overlay them over the visible cards. This, I think will give the most additional performance boost, but complicates things a lot. Even just keeping the existing structure and adding/removing the child text objects gets complicated. I have a rough draft and it is hard to read.<!--]--></p><h3 id="others" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#others" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Others<!--]--></a></h3><ul class="list-disc ps-6 my-5 marker:text-(--ui-border-accented)"><!--[--><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->As mentioned at the start, all those optimizations that I avoided can be allowed to happen for a speedup.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->I structured the app so we can potentially hook into document changes. That way instead of searching all notes for changes on updates, we can do surgically precise updates.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->The wrapping indexes + truncation index could be saved with the document and/or view. Once saved, we can just pass a pre-split line to Pixi.js and avoid text wrapping entirely.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->Due to how the app works, users can open multiple panes with the infinite canvas view. I will have to reduce the lod for unfocused instances past a certain note count to allow the focused / last focused canvas to stay performant.<!--]--></li><!--]--></ul><h3 id="usability-improvements-future-features" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#usability-improvements-future-features" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->Usability Improvements + Future Features<!--]--></a></h3><ul class="list-disc ps-6 my-5 marker:text-(--ui-border-accented)"><!--[--><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->For &lt; 1000 we can probably just disable the different lod states.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->To help with navigation, as mentioned, hovering over any note will show it in the corner - we can use a single object and just change it&#39;s text.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->Selection of notes - this can be done via sprite tinting.<!--]--></li><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->Movement - initially I had used a flat list because that would have made it easier to move notes but because we are now using a tree, this will require: hiding the note, creating a temporary copy that&#39;s on top of everything, then moving that.<!--]--></li><!--]--></ul><h3 id="avoid" class="relative text-xl text-highlighted font-bold mt-8 mb-3 scroll-mt-[calc(32px+45px+var(--ui-header-height))] lg:scroll-mt-[calc(32px+var(--ui-header-height))] [&amp;&gt;a]:focus-visible:outline-primary [&amp;&gt;a&gt;code]:border-dashed hover:[&amp;&gt;a&gt;code]:border-primary hover:[&amp;&gt;a&gt;code]:text-primary [&amp;&gt;a&gt;code]:text-lg/6 [&amp;&gt;a&gt;code]:font-bold [&amp;&gt;a&gt;code]:transition-colors"><a href="#avoid" class="group lg:ps-2 lg:-ms-2"><span class="absolute -ms-8 top-0.5 opacity-0 group-hover:opacity-100 group-focus:opacity-100 p-1 bg-elevated hover:text-primary rounded-md hidden lg:flex text-muted transition"><span class="iconify i-lucide:hash size-4 shrink-0" aria-hidden="true" style=""></span></span><!--[-->AVOID<!--]--></a></h3><ul class="list-disc ps-6 my-5 marker:text-(--ui-border-accented)"><!--[--><li class="my-1.5 ps-1.5 leading-7 [&amp;&gt;ul]:my-0"><!--[-->Do NOT use <code class="px-1.5 py-0.5 text-sm font-mono font-medium rounded-md inline-block border border-muted text-highlighted bg-muted"><!--[-->cacheAsTexture<!--]--></code> for the card with text. You&#39;re creating dozens of tiny textures which is pointless and worsens performance. If your notes are contained within some parant container of <em><!--[-->known<!--]--></em> size that is not too big (less than 4096x4096 pixels) it <em><!--[-->might<!--]--></em> help.<!--]--></li><!--]--></ul><style>html pre.shiki code .s7zQu, html code.shiki .s7zQu{--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-default:#89DDFF;--shiki-default-font-style:italic;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic}html pre.shiki code .sMK4o, html code.shiki .sMK4o{--shiki-light:#39ADB5;--shiki-default:#89DDFF;--shiki-dark:#89DDFF}html pre.shiki code .sTEyZ, html code.shiki .sTEyZ{--shiki-light:#90A4AE;--shiki-default:#EEFFFF;--shiki-dark:#BABED8}html pre.shiki code .sfazB, html code.shiki .sfazB{--shiki-light:#91B859;--shiki-default:#C3E88D;--shiki-dark:#C3E88D}html pre.shiki code .spNyl, html code.shiki .spNyl{--shiki-light:#9C3EDA;--shiki-default:#C792EA;--shiki-dark:#C792EA}html pre.shiki code .swJcz, html code.shiki .swJcz{--shiki-light:#E53935;--shiki-default:#F07178;--shiki-dark:#F07178}html pre.shiki code .sbssI, html code.shiki .sbssI{--shiki-light:#F76D47;--shiki-default:#F78C6C;--shiki-dark:#F78C6C}html pre.shiki code .s2Zo4, html code.shiki .s2Zo4{--shiki-light:#6182B8;--shiki-default:#82AAFF;--shiki-dark:#82AAFF}html pre.shiki code .sBMFI, html code.shiki .sBMFI{--shiki-light:#E2931D;--shiki-default:#FFCB6B;--shiki-dark:#FFCB6B}html pre.shiki code .sHdIc, html code.shiki .sHdIc{--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#EEFFFF;--shiki-default-font-style:italic;--shiki-dark:#BABED8;--shiki-dark-font-style:italic}html pre.shiki code .sHwdD, html code.shiki .sHwdD{--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#546E7A;--shiki-default-font-style:italic;--shiki-dark:#676E95;--shiki-dark-font-style:italic}html .light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html.light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sfNiH, html code.shiki .sfNiH{--shiki-light:#FF5370;--shiki-default:#FF9CAC;--shiki-dark:#FF9CAC}html pre.shiki code .s6hCs, html code.shiki .s6hCs{--shiki-light:#9C3EDA;--shiki-light-font-style:italic;--shiki-default:#C792EA;--shiki-default-font-style:italic;--shiki-dark:#C792EA;--shiki-dark-font-style:italic}</style></div><div class="flex items-center justify-end gap-2 text-sm text-muted"><!--[--><!--[--><button type="button" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors px-2.5 py-1.5 text-xs gap-1.5 text-muted hover:text-default active:text-default disabled:text-muted aria-disabled:text-muted focus:outline-none focus-visible:ring-inset focus-visible:ring-2 focus-visible:ring-inverted"><!--[--><!--[--><!----><!--]--><!--[--><span data-slot="label" class="truncate">Copy link</span><!--]--><!--[--><!----><!--]--><!--]--></button><!--]--><!--]--></div><!--[--><!----><div data-slot="root" class="grid grid-cols-1 sm:grid-cols-2 gap-8"><span class="hidden sm:block">Â </span><span class="hidden sm:block">Â </span></div><!--]--><!--]--></div><!--]--></div><!----></div><!--]--></div><!--]--></main><!--]--></main><!--]--><footer data-slot="root" class="z-10 bg-default"><!----><div class="w-full max-w-(--ui-container) mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-4 lg:flex lg:items-center lg:justify-between lg:gap-x-3" data-slot="container"><!--[--><div data-slot="right" class="lg:flex-1 flex items-center justify-center lg:justify-end gap-x-1.5 lg:order-3"><!--[--><!--[--><!--[--><!--[--><a href="https://x.com/alanscodelog" rel="noopener noreferrer" target="_blank" aria-label="X" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors text-xs gap-1 text-default hover:bg-elevated active:bg-elevated focus:outline-none focus-visible:bg-elevated hover:disabled:bg-transparent dark:hover:disabled:bg-transparent hover:aria-disabled:bg-transparent dark:hover:aria-disabled:bg-transparent p-1"><!--[--><!--[--><span class="iconify i-simple-icons:x shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></a><!--]--><!--]--><!--[--><!--[--><a href="https://github.com/alanscodelog" rel="noopener noreferrer" target="_blank" aria-label="GitHub" data-slot="base" class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors text-xs gap-1 text-default hover:bg-elevated active:bg-elevated focus:outline-none focus-visible:bg-elevated hover:disabled:bg-transparent dark:hover:disabled:bg-transparent hover:aria-disabled:bg-transparent dark:hover:aria-disabled:bg-transparent p-1"><!--[--><!--[--><span class="iconify i-simple-icons:github shrink-0 size-4" aria-hidden="true" style="" data-slot="leadingIcon"></span><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--><!--]--></a><!--]--><!--]--><!--]--><!--]--></div><div data-slot="center" class="mt-3 lg:mt-0 lg:order-2 flex items-center justify-center"><!--[--><!--]--></div><div data-slot="left" class="flex items-center justify-center lg:justify-start lg:flex-1 gap-x-1.5 mt-3 lg:mt-0 lg:order-1 text-xs"><!--[-->Copyright Â© 2026<!--]--></div><!--]--></div><!----></footer><!--]--></div></div><span></span><!--]--><!--]--><!--[--><!--]--><!--v-if--><!--]--><!--[--><!--]--><!--]--><!--]--></div><div id="teleports"></div><script>window.__NUXT__={};window.__NUXT__.config={public:{"nuxt-scripts":{version:"",defaultScriptOptions:{trigger:"onNuxtReady"}},studio:{route:"/_studio",dev:false,development:{server:""},repository:{provider:"github",owner:"",repo:"",branch:"main",rootDir:"",private:true},i18n:{defaultLocale:"en"}},mdc:{components:{prose:true,map:{accordion:"ProseAccordion","accordion-item":"ProseAccordionItem",badge:"ProseBadge",callout:"ProseCallout",card:"ProseCard","card-group":"ProseCardGroup",caution:"ProseCaution","code-collapse":"ProseCodeCollapse","code-group":"ProseCodeGroup","code-icon":"ProseCodeIcon","code-preview":"ProseCodePreview","code-tree":"ProseCodeTree",collapsible:"ProseCollapsible",field:"ProseField","field-group":"ProseFieldGroup",icon:"ProseIcon",kbd:"ProseKbd",note:"ProseNote",steps:"ProseSteps",tabs:"ProseTabs","tabs-item":"ProseTabsItem",tip:"ProseTip",warning:"ProseWarning"},customElements:[]},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}},highlight:{noApiRoute:true,theme:{light:"material-theme-lighter",default:"material-theme",dark:"material-theme-palenight"},highlighter:"shiki",shikiEngine:"oniguruma",langs:["js","jsx","json","ts","tsx","vue","css","html","bash","md","mdc","yaml"]}},"seo-utils":{canonicalQueryWhitelist:["page","sort","filter","search","q","category","tag"],canonicalLowercase:true},content:{wsUrl:""},"nuxt-robots":{version:"5.7.0",isNuxtContentV2:false,debug:false,credits:true,groups:[{comment:[],disallow:[""],allow:[],userAgent:["*"],contentUsage:["bots=y, train-ai=n"],contentSignal:["ai-train=no, search=yes, ai-input=yes"],_indexable:true,_rules:[],_normalized:true},{comment:[],disallow:["/"],allow:[],userAgent:["Google-Extended"],contentUsage:[],contentSignal:[],_indexable:false,_rules:[{pattern:"/",allow:false}],_normalized:true},{comment:[],disallow:["/"],allow:[],userAgent:["Applebot-Extended"],contentUsage:[],contentSignal:[],_indexable:false,_rules:[{pattern:"/",allow:false}],_normalized:true},{comment:[],disallow:["/"],allow:[],userAgent:["CCBot"],contentUsage:[],contentSignal:[],_indexable:false,_rules:[{pattern:"/",allow:false}],_normalized:true},{comment:[],disallow:["/"],allow:[],userAgent:["Bytespider"],contentUsage:[],contentSignal:[],_indexable:false,_rules:[{pattern:"/",allow:false}],_normalized:true},{comment:[],disallow:["/"],allow:[],userAgent:["Diffbot"],contentUsage:[],contentSignal:[],_indexable:false,_rules:[{pattern:"/",allow:false}],_normalized:true}],sitemap:["/sitemap.xml"],header:true,robotsEnabledValue:"index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",robotsDisabledValue:"noindex, nofollow",cacheControl:"max-age=14400, must-revalidate",botDetection:true,pageMetaRobots:{}}},app:{baseURL:"/",buildId:"a1c5c142-49ea-45d5-bcb0-40beb2dec1ff",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script><script type="application/ld+json" data-nuxt-schema-org="true" data-hid="schema-org-graph">{"@context":"https://schema.org","@graph":[{"@id":"https://alanscodelog.github.io/#website","@type":"WebSite","inLanguage":"en","name":"Alan's Code Log","url":"https://alanscodelog.github.io/"},{"@id":"https://alanscodelog.github.io/blog/performant-pixi-infinite-canvas/#webpage","@type":"WebPage","description":"A deep dive into the engineering behind Pyramid's infinite canvas and how to handle high-density layouts without sacrificing responsiveness â€” it covers texture baking, custom culling, background idle generation, efficient text handling, text truncation, and the dynamic LOD states required for massive datasets.","name":"Handling Thousands Cards on an Infinite Canvas","url":"https://alanscodelog.github.io/blog/performant-pixi-infinite-canvas/","isPartOf":{"@id":"https://alanscodelog.github.io/#website"},"potentialAction":[{"@type":"ReadAction","target":["https://alanscodelog.github.io/blog/performant-pixi-infinite-canvas/"]}]}]}</script><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__" data-src="/blog/performant-pixi-infinite-canvas/_payload.json?a1c5c142-49ea-45d5-bcb0-40beb2dec1ff">[{"state":1,"once":16,"_errors":17,"serverRendered":5,"path":19,"prerenderedAt":20},["Reactive",2],{"$scolor-mode":3,"$snuxt-seo-utils:routeRules":7,"$stoasts":8,"$ssite-config":9},{"preference":4,"value":4,"unknown":5,"forced":6},"system",true,false,{"head":-1,"seoMeta":-1},[],{"_priority":10,"env":13,"name":14,"trailingSlash":5,"url":15},{"name":11,"env":12,"url":11,"trailingSlash":11},-3,-15,"production","Alan's Code Log","https://alanscodelog.github.io",["Set"],["ShallowReactive",18],{"navigation":-1,"search":-1,"/blog/performant-pixi-infinite-canvas/":-1,"/blog/performant-pixi-infinite-canvas/-surround":-1},"/blog/performant-pixi-infinite-canvas/",1770083874483]</script></body></html>